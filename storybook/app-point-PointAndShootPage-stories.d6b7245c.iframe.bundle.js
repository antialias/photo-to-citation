"use strict";(self.webpackChunkapp_scaffold=self.webpackChunkapp_scaffold||[]).push([[2461],{"./src/apiClient.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{a:()=>apiEventSource,n:()=>apiFetch});var _basePath__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/basePath.ts");async function apiFetch(input,init){return fetch((0,_basePath__WEBPACK_IMPORTED_MODULE_0__.h)(input),init)}function apiEventSource(input){return new EventSource((0,_basePath__WEBPACK_IMPORTED_MODULE_0__.h)(input))}},"./src/app/components/NotificationProvider.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{l:()=>useNotify});__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js");var react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/next/dist/compiled/react/index.js");__webpack_require__("./node_modules/react-hot-toast/dist/index.mjs");const NotifyContext=(0,react__WEBPACK_IMPORTED_MODULE_1__.createContext)(()=>{});function useNotify(){return(0,react__WEBPACK_IMPORTED_MODULE_1__.useContext)(NotifyContext)}},"./src/app/point/PointAndShootPage.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Default:()=>Default,__namedExportsOrder:()=>__namedExportsOrder,default:()=>PointAndShootPage_stories});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),next_link=__webpack_require__("./node_modules/next/link.js"),link_default=__webpack_require__.n(next_link),navigation=__webpack_require__("./node_modules/@storybook/nextjs/dist/export-mocks/navigation/index.mjs"),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),es=__webpack_require__("./node_modules/react-i18next/dist/es/index.js"),useAddFilesToCase=__webpack_require__("./src/app/useAddFilesToCase.ts"),useNewCaseFromFiles=__webpack_require__("./src/app/useNewCaseFromFiles.ts"),console=__webpack_require__("./node_modules/console-browserify/index.js");function PointAndShootPage(){const videoRef=(0,react.useRef)(null),canvasRef=(0,react.useRef)(null),inputRef=(0,react.useRef)(null),workerRef=(0,react.useRef)(null),[analysisHint,setAnalysisHint]=(0,react.useState)(null),[cameraError,setCameraError]=(0,react.useState)(null),[uploading,setUploading]=(0,react.useState)(!1),[gps,setGps]=(0,react.useState)(null),{t}=(0,es.Bd)(),caseId=(0,navigation.useSearchParams)().get("case")||null,addFiles=(0,useAddFilesToCase.A)(null!=caseId?caseId:""),newCase=(0,useNewCaseFromFiles.A)(),uploadCase=caseId?addFiles:newCase;return(0,react.useEffect)(()=>{navigator.geolocation&&navigator.geolocation.getCurrentPosition(pos=>{setGps({lat:pos.coords.latitude,lon:pos.coords.longitude})})},[]),(0,react.useEffect)(()=>{!async function startCamera(){var _navigator_mediaDevices;if(null===(_navigator_mediaDevices=navigator.mediaDevices)||void 0===_navigator_mediaDevices?void 0:_navigator_mediaDevices.getUserMedia)if("https:"===location.protocol||"localhost"===location.hostname)try{const constraints={audio:!1,video:{facingMode:"environment"}},stream=await navigator.mediaDevices.getUserMedia(constraints),v=videoRef.current;v&&(v.setAttribute("autoplay",""),v.setAttribute("muted",""),v.setAttribute("playsinline",""),"srcObject"in v?v.srcObject=stream:v.src=URL.createObjectURL(stream),v.onloadedmetadata=()=>{v.play().catch(()=>{})})}catch(err){console.error("Could not access camera",err),setCameraError(t("cameraAccessError"))}else setCameraError(t("cameraRequiresSecure"));else setCameraError(t("cameraApiUnavailable"))}();const w="undefined"==typeof Worker?null:new Worker(new URL(__webpack_require__.p+__webpack_require__.u(333),__webpack_require__.b),{type:void 0});w&&(workerRef.current=w,w.postMessage({type:"load",modelUrl:"/models/demo.onnx"}),w.onmessage=e=>{if("result"===e.data.type){var _r_vehicle;const r=e.data.result;var _r_vehicle_licensePlateNumber,_ref;setAnalysisHint(null!==(_ref=null!==(_r_vehicle_licensePlateNumber=null===(_r_vehicle=r.vehicle)||void 0===_r_vehicle?void 0:_r_vehicle.licensePlateNumber)&&void 0!==_r_vehicle_licensePlateNumber?_r_vehicle_licensePlateNumber:r.violationType)&&void 0!==_ref?_ref:null)}});let handle=0;handle=window.setInterval(()=>{const video=videoRef.current,canvas=canvasRef.current;if(!video||!canvas||!w)return;const ctx=canvas.getContext("2d");if(!ctx)return;if(canvas.width=video.videoWidth,canvas.height=video.videoHeight,0===canvas.width||0===canvas.height)return;ctx.drawImage(video,0,0,canvas.width,canvas.height);const data=ctx.getImageData(0,0,canvas.width,canvas.height);w.postMessage({type:"analyze",image:data},[data.data.buffer])},2e3);const v=videoRef.current;return()=>{if(null==v?void 0:v.srcObject)for(const t of v.srcObject.getTracks())t.stop();w&&w.terminate(),clearInterval(handle)}},[t]),(0,jsx_runtime.jsxs)("div",{className:"relative h-[100dvh] overflow-hidden bg-black",children:[cameraError&&(0,jsx_runtime.jsx)("div",{className:"absolute inset-x-0 top-0 z-nav bg-red-600 text-white text-center py-2",children:cameraError}),(0,jsx_runtime.jsx)("video",{ref:videoRef,autoPlay:!0,muted:!0,playsInline:!0,className:"absolute inset-0 w-full h-full object-cover z-0",children:(0,jsx_runtime.jsx)("track",{kind:"captions",label:""})}),(0,jsx_runtime.jsx)("canvas",{ref:canvasRef,className:"hidden"}),uploading?(0,jsx_runtime.jsx)("div",{className:"absolute inset-0 bg-black/50 text-white flex items-center justify-center pointer-events-none text-xl z-nav",children:t("uploadingPhoto")}):null,(0,jsx_runtime.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none z-nav",children:(0,jsx_runtime.jsx)("div",{className:"bg-black/40 text-white px-2 py-1 rounded text-xl","data-testid":"hint",children:null!=analysisHint?analysisHint:t("nothingDetected")})}),(0,jsx_runtime.jsxs)("div",{className:"absolute inset-0 flex flex-col items-center justify-end gap-2 p-4 pointer-events-none",children:[(0,jsx_runtime.jsx)("input",{ref:inputRef,type:"file",accept:"image/*",multiple:!0,hidden:!0,onChange:e=>async function handleInputChange(files){setUploading(!0),await uploadCase(files)}(e.target.files)}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:()=>{var _inputRef_current;return null===(_inputRef_current=inputRef.current)||void 0===_inputRef_current?void 0:_inputRef_current.click()},disabled:uploading,className:"pointer-events-auto bg-white/80 text-black px-4 py-2 rounded disabled:opacity-50",children:t("uploadPicture")}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:async function takePicture(){if(!videoRef.current||!canvasRef.current)return;setUploading(!0);const video=videoRef.current,canvas=canvasRef.current;canvas.width=video.videoWidth,canvas.height=video.videoHeight;const ctx=canvas.getContext("2d");ctx&&(ctx.drawImage(video,0,0,canvas.width,canvas.height),canvas.toBlob(async blob=>{if(!blob)return;const file=new File([blob],"photo.jpg",{type:"image/jpeg"}),dt=new DataTransfer;dt.items.add(file),await uploadCase(dt.files,gps)},"image/jpeg"))},disabled:uploading,className:"pointer-events-auto bg-blue-600 text-white px-4 py-2 rounded w-full disabled:opacity-50",children:t("takePicture")}),(0,jsx_runtime.jsx)(link_default(),{href:caseId?`/cases/${caseId}`:"/cases",className:"pointer-events-auto text-xs text-white underline mt-2",children:t(caseId?"backToCase":"nav.cases")})]})]})}PointAndShootPage.__docgenInfo={description:"",methods:[],displayName:"PointAndShootPage"};const PointAndShootPage_stories={component:PointAndShootPage,title:"Pages/PointAndShootPage"},Default={render:()=>(0,jsx_runtime.jsx)(PointAndShootPage,{})},__namedExportsOrder=["Default"];Default.parameters={...Default.parameters,docs:{...Default.parameters?.docs,source:{originalSource:"{\n  render: () => <PointAndShootPage />\n}",...Default.parameters?.docs?.source}}}},"./src/app/useAddFilesToCase.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>useAddFilesToCase});var _apiClient__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/apiClient.ts"),_tanstack_react_query__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/@tanstack/react-query/build/modern/useMutation.js"),next_navigation__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@storybook/nextjs/dist/export-mocks/navigation/index.mjs"),react_i18next__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/react-i18next/dist/es/index.js"),_components_NotificationProvider__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/app/components/NotificationProvider.tsx");function useAddFilesToCase(caseId){const router=(0,next_navigation__WEBPACK_IMPORTED_MODULE_1__.useRouter)(),notify=(0,_components_NotificationProvider__WEBPACK_IMPORTED_MODULE_3__.l)(),{t}=(0,react_i18next__WEBPACK_IMPORTED_MODULE_2__.Bd)(),uploadMutation=(0,_tanstack_react_query__WEBPACK_IMPORTED_MODULE_4__.n)({mutationFn:async formData=>(0,_apiClient__WEBPACK_IMPORTED_MODULE_0__.n)("/api/upload",{method:"POST",body:formData})});return async(files,gps)=>{if(!files||0===files.length)return;(await Promise.all(Array.from(files).map(file=>{const formData=new FormData;return formData.append("photo",file),formData.append("caseId",caseId),gps&&(formData.append("lat",String(gps.lat)),formData.append("lon",String(gps.lon))),uploadMutation.mutateAsync(formData)}))).some(r=>!r.ok)?notify(t("failedUpload")):router.push(`/cases/${caseId}`)}}},"./src/app/useNewCaseFromFiles.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>useNewCaseFromFiles});var _apiClient__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/apiClient.ts"),_tanstack_react_query__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/@tanstack/react-query/build/modern/useMutation.js"),next_navigation__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@storybook/nextjs/dist/export-mocks/navigation/index.mjs"),react_i18next__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/react-i18next/dist/es/index.js"),_components_NotificationProvider__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/app/components/NotificationProvider.tsx");function useNewCaseFromFiles(){const router=(0,next_navigation__WEBPACK_IMPORTED_MODULE_1__.useRouter)(),notify=(0,_components_NotificationProvider__WEBPACK_IMPORTED_MODULE_3__.l)(),{t}=(0,react_i18next__WEBPACK_IMPORTED_MODULE_2__.Bd)(),uploadMutation=(0,_tanstack_react_query__WEBPACK_IMPORTED_MODULE_4__.n)({mutationFn:async formData=>(0,_apiClient__WEBPACK_IMPORTED_MODULE_0__.n)("/api/upload",{method:"POST",body:formData})});return async(files,gps)=>{if(!files||0===files.length)return;const id=crypto.randomUUID(),preview=URL.createObjectURL(files[0]);sessionStorage.setItem(`preview-${id}`,preview);(await Promise.all(Array.from(files).map((file,idx)=>{const formData=new FormData;formData.append("photo",file),formData.append("caseId",id),gps&&(formData.append("lat",String(gps.lat)),formData.append("lon",String(gps.lon)));const upload=uploadMutation.mutateAsync(formData);return 0===idx&&upload.then(()=>{sessionStorage.removeItem(`preview-${id}`)}),upload}))).some(r=>!r.ok)?notify(t("failedUpload")):router.push(`/cases/${id}`)}}},"./src/basePath.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{h:()=>withBasePath});var _publicEnv__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/publicEnv.ts");__webpack_require__("./node_modules/process/browser.js");function withBasePath(path){return`${function getBasePath(){var _getPublicEnv_NEXT_PUBLIC_BASE_PATH;return null!==(_getPublicEnv_NEXT_PUBLIC_BASE_PATH=(0,_publicEnv__WEBPACK_IMPORTED_MODULE_0__.j)().NEXT_PUBLIC_BASE_PATH)&&void 0!==_getPublicEnv_NEXT_PUBLIC_BASE_PATH?_getPublicEnv_NEXT_PUBLIC_BASE_PATH:""}()}${path}`}},"./src/publicEnv.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function getPublicEnv(){var _window_PUBLIC_ENV;return null!==(_window_PUBLIC_ENV=window.PUBLIC_ENV)&&void 0!==_window_PUBLIC_ENV?_window_PUBLIC_ENV:{}}__webpack_require__.d(__webpack_exports__,{j:()=>getPublicEnv})}}]);