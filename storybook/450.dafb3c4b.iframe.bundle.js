"use strict";(self.webpackChunkapp_scaffold=self.webpackChunkapp_scaffold||[]).push([[450],{"./src/app/cases/[id]/ClientCasePage.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>ClientCasePage});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),next_image=__webpack_require__("./node_modules/@storybook/nextjs/dist/images/next-image.mjs"),next_link=__webpack_require__("./node_modules/next/link.js"),link_default=__webpack_require__.n(next_link),navigation=__webpack_require__("./node_modules/@storybook/nextjs/dist/export-mocks/navigation/index.mjs"),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),caseUtils=__webpack_require__("./src/lib/caseUtils.ts"),AnalysisInfo=__webpack_require__("./src/app/components/AnalysisInfo.tsx");function CaseLayout({header,left,right,children}){return(0,jsx_runtime.jsxs)("div",{className:"p-8 flex flex-col gap-4",children:[(0,jsx_runtime.jsx)("div",{className:"sticky top-0 bg-white dark:bg-gray-900 z-10",children:header}),(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[35%_65%] lg:grid-cols-[30%_70%] gap-4 md:gap-6",children:[(0,jsx_runtime.jsx)("div",{children:left}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col gap-4",children:right})]}),children]})}CaseLayout.__docgenInfo={description:"",methods:[],displayName:"CaseLayout",props:{header:{required:!0,tsType:{name:"ReactNode"},description:""},left:{required:!0,tsType:{name:"ReactNode"},description:""},right:{required:!0,tsType:{name:"ReactNode"},description:""},children:{required:!1,tsType:{name:"ReactNode"},description:""}}};var dynamic=__webpack_require__("./node_modules/next/dynamic.js"),dynamic_default=__webpack_require__.n(dynamic),tippy_esm=__webpack_require__("./node_modules/tippy.js/dist/tippy.esm.js");__webpack_require__("./node_modules/process/browser.js").env.VITEST||__webpack_require__.e(240).then(__webpack_require__.bind(__webpack_require__,"./node_modules/tippy.js/dist/tippy.css"));const UPLOADED_PREVIEW_COUNT=4,Mermaid=dynamic_default()((()=>Promise.all([__webpack_require__.e(425),__webpack_require__.e(508)]).then(__webpack_require__.bind(__webpack_require__,"./node_modules/react-mermaid2/dist/Mermaid.js"))),{loadableGenerated:{webpack:()=>["./node_modules/react-mermaid2/dist/Mermaid.js"]},ssr:!1}),allSteps=[{id:"uploaded",label:"Photographs Uploaded"},{id:"analysis",label:"Analysis Complete"},{id:"violation",label:"Violation Identified"},{id:"noviol",label:"No Violation Identified"},{id:"plate",label:"License Plate Identified"},{id:"vin",label:"VIN Verified"},{id:"ownreq",label:"Ownership Info Requested"},{id:"own",label:"Ownership Info Obtained"},{id:"ownnotify",label:"Registered Owner Notified"},{id:"notify",label:"Authorities Notified"},{id:"confirm",label:"Authority Response Confirmed"},{id:"sent",label:"Citation Sent"},{id:"received",label:"Citation Received"}];function CaseProgressGraph({caseData}){const analysisDone="complete"===caseData.analysisStatus,violation=analysisDone&&(0,caseUtils.UO)(caseData.analysis),noviolation=analysisDone&&!violation,analysisPending="pending"===caseData.analysisStatus&&!caseData.analysis&&caseData.analysisProgress,reanalysisPending="pending"===caseData.analysisStatus&&Boolean(caseData.analysis)&&caseData.analysisProgress,steps=(0,react.useMemo)((()=>noviolation?allSteps.filter((s=>["uploaded","analysis","noviol"].includes(s.id))):allSteps.filter((s=>"noviol"!==s.id))),[noviolation]),status=(0,react.useMemo)((()=>({uploaded:!0,analysis:analysisDone,violation,noviol:noviolation,plate:violation&&Boolean((0,caseUtils.qy)(caseData)||(0,caseUtils.W7)(caseData)),vin:violation&&Boolean((0,caseUtils.E5)(caseData)),ownreq:Boolean(caseData.ownershipRequests&&caseData.ownershipRequests.length>0),own:Boolean((0,caseUtils.g_)(caseData)),ownnotify:Boolean((()=>{const info=(0,caseUtils.sC)(caseData);var _caseData_sentEmails;return!!(null==info?void 0:info.email)&&(null!==(_caseData_sentEmails=caseData.sentEmails)&&void 0!==_caseData_sentEmails?_caseData_sentEmails:[]).some((m=>m.to===info.email))})()),notify:Boolean(caseData.sentEmails&&caseData.sentEmails.length>0),confirm:!1,sent:!1,received:!1})),[analysisDone,violation,noviolation,caseData]),firstPending=steps.findIndex((s=>!status[s.id])),[isDark,setIsDark]=(0,react.useState)(!1);(0,react.useEffect)((()=>{const mql=window.matchMedia("(prefers-color-scheme: dark)");setIsDark(mql.matches);const listener=e=>setIsDark(e.matches);return mql.addEventListener("change",listener),()=>mql.removeEventListener("change",listener)}),[]);const chart=(0,react.useMemo)((()=>{var _caseData_sentEmails;const nodes=steps.map((s=>`${s.id}["${s.label}"]`)).join("\n"),edgesList=[];edgesList.push(["uploaded","analysis",!0,analysisPending?"analysis requested":null]),reanalysisPending&&edgesList.push(["analysis","analysis",!0,"re-analysis requested"]),noviolation?edgesList.push(["analysis","noviol",!0,"no violation"]):(edgesList.push(["analysis","violation",!0,"evaluating"]),edgesList.push(["violation","plate",!0,"detecting plate"]),edgesList.push(["plate","vin",!0,"decoding VIN"]),edgesList.push(["plate","ownreq",!0,"requesting ownership"]),edgesList.push(["vin","ownreq",!1,"lookup ownership"]),edgesList.push(["ownreq","own",!0,"awaiting ownership info"]),edgesList.push(["own","ownnotify",!0,"notifying owner"]),edgesList.push(["violation","notify",!0,"notifying authorities"]),edgesList.push(["notify","confirm",!0,"awaiting response from authorities"]),edgesList.push(["confirm","sent",!0,"citation processing"]),edgesList.push(["sent","received",!0,"awaiting delivery"]));const activeFromIdx=firstPending>0?firstPending-1:-1;let activeFrom=activeFromIdx>=0?steps[activeFromIdx].id:null;const activeTo=firstPending>=0?steps[firstPending].id:null;reanalysisPending&&(activeFrom="analysis");const edges=edgesList.map((([a,b,hard,label])=>`${a}${hard?"--\x3e":"-.->"}${label&&a===activeFrom&&b===activeTo?`|${label}|`:""}${b}`)).join("\n"),classAssignments=steps.map(((s,i)=>{const cls=status[s.id]?"completed":i===firstPending?"current":"pending";return`class ${s.id} ${cls}`})).join("\n"),platePhoto=(()=>{var _caseData_analysis;const plate=(0,caseUtils.qy)(caseData);var _caseData_photos_,_caseData_photos_1;if(!plate||!(null===(_caseData_analysis=caseData.analysis)||void 0===_caseData_analysis?void 0:_caseData_analysis.images))return null!==(_caseData_photos_=caseData.photos[0])&&void 0!==_caseData_photos_?_caseData_photos_:null;for(const[name,info]of Object.entries(caseData.analysis.images)){var _info_paperworkInfo_vehicle,_info_paperworkInfo,_info_highlights;if((null===(_info_paperworkInfo=info.paperworkInfo)||void 0===_info_paperworkInfo||null===(_info_paperworkInfo_vehicle=_info_paperworkInfo.vehicle)||void 0===_info_paperworkInfo_vehicle?void 0:_info_paperworkInfo_vehicle.licensePlateNumber)===plate||(null===(_info_highlights=info.highlights)||void 0===_info_highlights?void 0:_info_highlights.toLowerCase().includes("plate"))){const file=caseData.photos.find((p=>p.split("/").pop()===name));if(file)return file}}return null!==(_caseData_photos_1=caseData.photos[0])&&void 0!==_caseData_photos_1?_caseData_photos_1:null})();var _caseData_threadImages;const ownerDoc=(null!==(_caseData_threadImages=caseData.threadImages)&&void 0!==_caseData_threadImages?_caseData_threadImages:[]).find((i=>{var _i_ocrInfo;return null===(_i_ocrInfo=i.ocrInfo)||void 0===_i_ocrInfo?void 0:_i_ocrInfo.contact})),ownerLink=ownerDoc?ownerDoc.threadParent?`/cases/${caseData.id}/thread/${encodeURIComponent(ownerDoc.threadParent)}`:ownerDoc.url:null,ownerInfo=(0,caseUtils.sC)(caseData);var _caseData_sentEmails1;const ownerNotifyEmail=(null==ownerInfo?void 0:ownerInfo.email)?(null!==(_caseData_sentEmails1=caseData.sentEmails)&&void 0!==_caseData_sentEmails1?_caseData_sentEmails1:[]).find((m=>m.to===ownerInfo.email)):void 0,ownerNotifyLink=ownerNotifyEmail?`/cases/${caseData.id}/thread/${encodeURIComponent(ownerNotifyEmail.sentAt)}`:null,firstEmail=null===(_caseData_sentEmails=caseData.sentEmails)||void 0===_caseData_sentEmails?void 0:_caseData_sentEmails.find((m=>!(null==ownerInfo?void 0:ownerInfo.email)||m.to!==ownerInfo.email)),notifyLink=firstEmail?`/cases/${caseData.id}/thread/${encodeURIComponent(firstEmail.sentAt)}`:null,clean=t=>t.replace(/"/g,"'");var _caseData_photoTimes_caseData_photos_;const uploadedAt=null!==(_caseData_photoTimes_caseData_photos_=caseData.photoTimes[caseData.photos[0]])&&void 0!==_caseData_photoTimes_caseData_photos_?_caseData_photoTimes_caseData_photos_:null,uploadedTip=uploadedAt?`Photo taken ${new Date(uploadedAt).toLocaleString()}`:"View uploaded photo",plateTipParts=[],plateNum=(0,caseUtils.qy)(caseData),plateState=(0,caseUtils.W7)(caseData);plateNum&&plateTipParts.push(`Plate: ${plateNum}`),plateState&&plateTipParts.push(`State: ${plateState}`),platePhoto&&plateTipParts.push("View plate photo");const plateTip=plateTipParts.join(" – "),ownerContact=(0,caseUtils.g_)(caseData),ownerTip=ownerContact?`Owner info: ${ownerContact.slice(0,40)}${ownerContact.length>40?"…":""}`:"View paperwork",notifyTip=firstEmail?`Notification email to ${firstEmail.to} on ${new Date(firstEmail.sentAt).toLocaleString()}`:"View notification email",ownerNotifyTip=ownerNotifyEmail?`Notification email to ${ownerNotifyEmail.to} on ${new Date(ownerNotifyEmail.sentAt).toLocaleString()}`:"View owner notification",analysisTip=caseData.analysis&&(0,caseUtils.Pk)(caseData.analysis),links=[caseData.photos[0]?`click uploaded "${caseData.photos[0]}" "${clean(uploadedTip)}"`:null,platePhoto?`click plate "${platePhoto}" "${clean(plateTip)}"`:null,ownerLink?`click own "${ownerLink}" "${clean(ownerTip)}"`:null,ownerNotifyLink?`click ownnotify "${ownerNotifyLink}" "${clean(ownerNotifyTip)}"`:null,notifyLink?`click notify "${notifyLink}" "${clean(notifyTip)}"`:null,analysisTip?`click analysis "/cases/${caseData.id}" "${clean(analysisTip)}"`:null].filter(Boolean).join("\n"),c=isDark?{completedFill:"#064E3B",completedStroke:"#10B981",currentFill:"#78350F",currentStroke:"#FBBF24",pendingFill:"#1F2937",pendingStroke:"#9CA3AF"}:{completedFill:"#D1FAE5",completedStroke:"#047857",currentFill:"#FEF3C7",currentStroke:"#92400E",pendingFill:"#F3F4F6",pendingStroke:"#6B7280"},textColor=isDark?"#F9FAFB":"#000000";return`graph TD\n${nodes}\n${edges}\n${links}\nclassDef completed fill:${c.completedFill},stroke:${c.completedStroke},color:${textColor};\nclassDef current fill:${c.currentFill},stroke:${c.currentStroke},color:${textColor};\nclassDef pending fill:${c.pendingFill},stroke:${c.pendingStroke},color:${textColor};\n${`linkStyle default fill:none,stroke:${c.pendingStroke},stroke-width:2px;`}\n${classAssignments}`}),[status,firstPending,noviolation,steps,isDark,caseData,analysisPending,reanalysisPending]),containerRef=(0,react.useRef)(null);return(0,react.useEffect)((()=>{const container=containerRef.current;if(!container)return;const instances=[],apply=()=>{var _caseData_sentEmails;for(const inst of instances)inst.destroy();instances.length=0;const map={},platePhoto=(()=>{var _caseData_analysis;const plate=(0,caseUtils.qy)(caseData);var _caseData_photos_,_caseData_photos_1;if(!plate||!(null===(_caseData_analysis=caseData.analysis)||void 0===_caseData_analysis?void 0:_caseData_analysis.images))return null!==(_caseData_photos_=caseData.photos[0])&&void 0!==_caseData_photos_?_caseData_photos_:null;for(const[name,info]of Object.entries(caseData.analysis.images)){var _info_paperworkInfo_vehicle,_info_paperworkInfo,_info_highlights;if((null===(_info_paperworkInfo=info.paperworkInfo)||void 0===_info_paperworkInfo||null===(_info_paperworkInfo_vehicle=_info_paperworkInfo.vehicle)||void 0===_info_paperworkInfo_vehicle?void 0:_info_paperworkInfo_vehicle.licensePlateNumber)===plate||(null===(_info_highlights=info.highlights)||void 0===_info_highlights?void 0:_info_highlights.toLowerCase().includes("plate"))){const file=caseData.photos.find((p=>p.split("/").pop()===name));if(file)return file}}return null!==(_caseData_photos_1=caseData.photos[0])&&void 0!==_caseData_photos_1?_caseData_photos_1:null})();var _caseData_threadImages;const ownerDoc=(null!==(_caseData_threadImages=caseData.threadImages)&&void 0!==_caseData_threadImages?_caseData_threadImages:[]).find((i=>{var _i_ocrInfo;return null===(_i_ocrInfo=i.ocrInfo)||void 0===_i_ocrInfo?void 0:_i_ocrInfo.contact})),ownerLink=ownerDoc?ownerDoc.threadParent?`/cases/${caseData.id}/thread/${encodeURIComponent(ownerDoc.threadParent)}`:ownerDoc.url:null,ownerInfo=(0,caseUtils.sC)(caseData);var _caseData_sentEmails1;const ownerNotifyEmail=(null==ownerInfo?void 0:ownerInfo.email)?(null!==(_caseData_sentEmails1=caseData.sentEmails)&&void 0!==_caseData_sentEmails1?_caseData_sentEmails1:[]).find((m=>m.to===ownerInfo.email)):void 0,ownerNotifyLink=ownerNotifyEmail?`/cases/${caseData.id}/thread/${encodeURIComponent(ownerNotifyEmail.sentAt)}`:null,firstEmail=null===(_caseData_sentEmails=caseData.sentEmails)||void 0===_caseData_sentEmails?void 0:_caseData_sentEmails.find((m=>!(null==ownerInfo?void 0:ownerInfo.email)||m.to!==ownerInfo.email)),notifyLink=firstEmail?`/cases/${caseData.id}/thread/${encodeURIComponent(firstEmail.sentAt)}`:null,bestViolation=(0,caseUtils._g)(caseData);var _ownerDoc_url,_ownerNotifyEmail_body,_firstEmail_body;caseData.photos.length>0&&(map.uploaded={url:caseData.photos[0],preview:caseData.photos.slice(-UPLOADED_PREVIEW_COUNT),isImage:!0,count:caseData.photos.length}),platePhoto&&(map.plate={url:platePhoto,preview:platePhoto,isImage:!0}),ownerLink&&(map.own={url:ownerLink,preview:null!==(_ownerDoc_url=null==ownerDoc?void 0:ownerDoc.url)&&void 0!==_ownerDoc_url?_ownerDoc_url:ownerLink,isImage:!0}),ownerNotifyLink&&(map.ownnotify={url:ownerNotifyLink,preview:null!==(_ownerNotifyEmail_body=null==ownerNotifyEmail?void 0:ownerNotifyEmail.body)&&void 0!==_ownerNotifyEmail_body?_ownerNotifyEmail_body:"",isImage:!1}),notifyLink&&(map.notify={url:notifyLink,preview:null!==(_firstEmail_body=null==firstEmail?void 0:firstEmail.body)&&void 0!==_firstEmail_body?_firstEmail_body:"",isImage:!1}),bestViolation&&(map.violation={url:bestViolation.photo,preview:bestViolation.photo,isImage:!0,caption:bestViolation.caption});const vin=(0,caseUtils.E5)(caseData);vin&&(map.vin={url:"",preview:vin,isImage:!1}),caseData.analysis&&(map.analysis={url:`/cases/${caseData.id}`,preview:(0,caseUtils.Pk)(caseData.analysis),isImage:!1});const escapeHtml=s=>s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");for(const[id,info]of Object.entries(map)){if(!info)continue;const el=container.querySelector(`[id^='flowchart-${id}-']`);if(!el)continue;const content=(()=>{if(!1!==info.isImage){if(Array.isArray(info.preview)){const imgClass=info.preview.length>1?"max-h-24 my-1":"max-h-40",imgs=info.preview.map((p=>`<img src="${p}" class="${imgClass}" />`)).join(""),extra=info.count&&info.count>info.preview.length?info.count-info.preview.length:0;return`<div class="flex flex-col items-center overflow-y-auto" style="max-height:60vh; max-width:80vw;">${imgs}${extra>0?`<div class="text-xs text-center mt-1">and ${extra} more photo${1===extra?"":"s"} not shown</div>`:""}</div>`}const caption=info.caption?`<div class="text-xs text-center mt-1">${escapeHtml(info.caption)}</div>`:"";return`<div class="flex flex-col items-center"><img src="${info.preview}" class="max-h-40" />${caption}</div>`}return`<div class="max-w-xs whitespace-pre-wrap">${escapeHtml(info.preview)}</div>`})(),inst=(0,tippy_esm.Ay)(el,{content,allowHTML:!0});el.addEventListener("click",(()=>window.open(info.url,"_blank"))),instances.push(inst)}},observer=new MutationObserver((()=>apply()));observer.observe(container,{childList:!0,subtree:!0});const timer=window.setTimeout(apply,500);return()=>{observer.disconnect(),clearTimeout(timer);for(const inst of instances)inst.destroy()}}),[caseData]),(0,jsx_runtime.jsx)("div",{className:"max-w-full overflow-x-auto",ref:containerRef,children:(0,jsx_runtime.jsx)(Mermaid,{chart,config:{theme:isDark?"dark":"default",themeVariables:isDark?{primaryTextColor:"#F9FAFB",textColor:"#F9FAFB",nodeTextColor:"#F9FAFB"}:{}}},chart)})}CaseProgressGraph.__docgenInfo={description:"",methods:[],displayName:"CaseProgressGraph",props:{caseData:{required:!0,tsType:{name:"Case"},description:""}}};var dist=__webpack_require__("./node_modules/@radix-ui/react-progress/dist/index.mjs");const Progress=react.forwardRef((({value,indeterminate,className,...props},ref)=>(0,jsx_runtime.jsx)(dist.bL,{ref,className:`relative h-2 w-full overflow-hidden rounded-full bg-gray-300 dark:bg-gray-700 ${null!=className?className:""}`,...props,children:(0,jsx_runtime.jsx)(dist.C1,{className:"h-full w-full bg-blue-600 transition-transform "+(indeterminate?"animate-progress":""),style:{transform:`translateX(-${100-(null!=value?value:0)}%)`}})})));function useCloseOnOutsideClick(ref){(0,react.useEffect)((()=>{function handleClick(e){const el=ref.current;(null==el?void 0:el.open)&&e.target instanceof Node&&!el.contains(e.target)&&el.removeAttribute("open")}return document.addEventListener("click",handleClick),()=>{document.removeEventListener("click",handleClick)}}),[ref])}function CaseToolbar({caseId,disabled=!1,hasOwner=!1,progress}){const reqText=progress?"upload"===progress.stage?progress.index>0?`Uploading ${progress.index} of ${progress.total} photos (${Math.floor(progress.index/progress.total*100)}%)`:"Uploading photos...":progress.done?"Processing results...":`Analyzing... ${progress.received} of ${progress.total} tokens`:null,progressText=progress?`${progress.steps?`Step ${progress.step} of ${progress.steps}: `:""}${reqText}`:null,requestValue=progress?"upload"===progress.stage?progress.index>0?progress.index/progress.total*100:void 0:Math.min(progress.received/progress.total*100,100):void 0,overallValue=void 0!==(null==progress?void 0:progress.steps)&&void 0!==progress.step?(progress.step-1+(null!=requestValue?requestValue:0)/100)/progress.steps*100:void 0,detailsRef=(0,react.useRef)(null);return useCloseOnOutsideClick(detailsRef),(0,jsx_runtime.jsxs)("div",{className:"bg-gray-100 dark:bg-gray-800 px-8 py-2 flex flex-col gap-2 flex-1",children:[progress?(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)(Progress,{value:overallValue,indeterminate:void 0===overallValue}),(0,jsx_runtime.jsx)(Progress,{value:requestValue,indeterminate:void 0===requestValue}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:progressText})]}):null,(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsxs)("details",{ref:detailsRef,className:"relative",children:[(0,jsx_runtime.jsx)("summary",{className:"cursor-pointer select-none bg-gray-300 dark:bg-gray-700 px-2 py-1 rounded",children:"Actions"}),(0,jsx_runtime.jsxs)("div",{className:"absolute right-0 mt-1 bg-white dark:bg-gray-900 border rounded shadow",children:[(0,jsx_runtime.jsx)("button",{type:"button",onClick:async()=>{await fetch(`/api/cases/${caseId}/reanalyze`,{method:"POST"}),window.location.reload()},className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:"Re-run Analysis"}),disabled?null:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[progress?(0,jsx_runtime.jsx)("button",{type:"button",onClick:async()=>{await fetch(`/api/cases/${caseId}/cancel-analysis`,{method:"POST"}),window.location.reload()},className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:"Cancel Analysis"}):null,(0,jsx_runtime.jsx)(link_default(),{href:`/cases/${caseId}/compose`,className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Draft Email to Authorities"}),hasOwner?null:(0,jsx_runtime.jsx)(link_default(),{href:`/cases/${caseId}/ownership`,className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Request Ownership Info"}),hasOwner?(0,jsx_runtime.jsx)(link_default(),{href:`/cases/${caseId}/notify-owner`,className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Notify Registered Owner"}):null]}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:async()=>{const code=Math.random().toString(36).slice(2,6);prompt(`Type '${code}' to confirm deleting this case.`)===code&&(await fetch(`/api/cases/${caseId}`,{method:"DELETE"}),window.location.href="/cases")},className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:"Delete Case"})]})]})})]})}Progress.displayName="Progress",Progress.__docgenInfo={description:"",methods:[],displayName:"Progress",props:{value:{required:!1,tsType:{name:"number"},description:""},indeterminate:{required:!1,tsType:{name:"boolean"},description:""}}},CaseToolbar.__docgenInfo={description:"",methods:[],displayName:"CaseToolbar",props:{caseId:{required:!0,tsType:{name:"string"},description:""},disabled:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},hasOwner:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},progress:{required:!1,tsType:{name:"union",raw:"LlmProgress | null",elements:[{name:"union",raw:'| {\n    stage: "upload";\n    index: number;\n    total: number;\n    step?: number;\n    steps?: number;\n  }\n| {\n    stage: "stream";\n    received: number;\n    total: number;\n    done: boolean;\n    step?: number;\n    steps?: number;\n  }',elements:[{name:"signature",type:"object",raw:'{\n  stage: "upload";\n  index: number;\n  total: number;\n  step?: number;\n  steps?: number;\n}',signature:{properties:[{key:"stage",value:{name:"literal",value:'"upload"',required:!0}},{key:"index",value:{name:"number",required:!0}},{key:"total",value:{name:"number",required:!0}},{key:"step",value:{name:"number",required:!1}},{key:"steps",value:{name:"number",required:!1}}]}},{name:"signature",type:"object",raw:'{\n  stage: "stream";\n  received: number;\n  total: number;\n  done: boolean;\n  step?: number;\n  steps?: number;\n}',signature:{properties:[{key:"stage",value:{name:"literal",value:'"stream"',required:!0}},{key:"received",value:{name:"number",required:!0}},{key:"total",value:{name:"number",required:!0}},{key:"done",value:{name:"boolean",required:!0}},{key:"step",value:{name:"number",required:!1}},{key:"steps",value:{name:"number",required:!1}}]}}]},{name:"null"}]},description:""}}};var EditableText=__webpack_require__("./src/app/components/EditableText.tsx");function ImageHighlights({analysis,photo}){var _analysis_images;const name=photo.split("/").pop()||photo,info=null===(_analysis_images=analysis.images)||void 0===_analysis_images?void 0:_analysis_images[name];return info?(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1 text-sm",children:[(0,jsx_runtime.jsxs)("span",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Image score:"})," ",info.representationScore.toFixed(2)]}),info.highlights?(0,jsx_runtime.jsx)("span",{children:info.highlights}):null]}):null}ImageHighlights.__docgenInfo={description:"",methods:[],displayName:"ImageHighlights",props:{analysis:{required:!0,tsType:{name:"z.infer",elements:[{name:"violationReportSchema"}],raw:"z.infer<typeof violationReportSchema>"},description:""},photo:{required:!0,tsType:{name:"string"},description:""}}};var MapPreview=__webpack_require__("./src/app/components/MapPreview.tsx"),useDragReset=__webpack_require__("./src/app/cases/useDragReset.ts");function buildThreads(c){var _c_sentEmails;const mails=null!==(_c_sentEmails=c.sentEmails)&&void 0!==_c_sentEmails?_c_sentEmails:[],threads=new Map;for(const mail of mails){let root=mail;for(;root.replyTo;){const parent=mails.find((m=>m.sentAt===root.replyTo));if(!parent)break;root=parent}const current=threads.get(root.sentAt);(!current||new Date(mail.sentAt)>new Date(current.sentAt))&&threads.set(root.sentAt,mail)}return Array.from(threads.values()).sort(((a,b)=>new Date(a.sentAt).getTime()-new Date(b.sentAt).getTime()))}function baseName(filePath){const parts=filePath.split(/[\\/]/);return parts[parts.length-1]}function ClientCasePage({initialCase,caseId}){var _caseData_analysisOverrides_vehicle,_caseData_analysisOverrides,_caseData_analysisOverrides_vehicle1,_caseData_analysisOverrides1,_caseData_analysis;const[caseData,setCaseData]=(0,react.useState)(initialCase),[preview,setPreview]=(0,react.useState)(null),[selectedPhoto,setSelectedPhoto]=(0,react.useState)(initialCase?(0,caseUtils.wq)(initialCase):null),[plate,setPlate]=(0,react.useState)(initialCase&&(0,caseUtils.qy)(initialCase)||""),[plateState,setPlateState]=(0,react.useState)(initialCase&&(0,caseUtils.W7)(initialCase)||""),[vin,setVin]=(0,react.useState)(initialCase&&(0,caseUtils.E5)(initialCase)||""),router=(0,navigation.useRouter)(),fileInputRef=(0,react.useRef)(null),[dragging,setDragging]=(0,react.useState)(!1);async function uploadFiles(files){if(!files||0===files.length)return;if((await Promise.all(Array.from(files).map((file=>{const formData=new FormData;return formData.append("photo",file),formData.append("caseId",caseId),fetch("/api/upload",{method:"POST",body:formData})})))).some((r=>!r.ok)))return void alert("Failed to upload one or more files.");const res=await fetch(`/api/cases/${caseId}`);if(res.ok){const data=await res.json();setCaseData(data)}else alert("Failed to refresh case after upload.");router.refresh(),fileInputRef.current&&(fileInputRef.current.value="")}async function refreshCase(){const res=await fetch(`/api/cases/${caseId}`);if(res.ok){const data=await res.json();setCaseData(data)}else alert("Failed to refresh case.")}async function updateVehicle(plateNum,plateSt){(await fetch(`/api/cases/${caseId}/override`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({vehicle:{licensePlateNumber:plateNum||void 0,licensePlateState:plateSt||void 0}})})).ok?await refreshCase():alert("Failed to update vehicle information.")}async function removePhoto(photo){if(!(await fetch(`/api/cases/${caseId}/photos`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({photo})})).ok)return void alert("Failed to remove photo.");const res=await fetch(`/api/cases/${caseId}`);if(res.ok){const data=await res.json();setCaseData(data)}else alert("Failed to refresh case after removing photo.");router.refresh()}if((0,useDragReset.A)((()=>{setDragging(!1)})),(0,react.useEffect)((()=>{const stored=sessionStorage.getItem(`preview-${caseId}`);stored&&setPreview(stored),fetch(`/api/cases/${caseId}`).then((async res=>{if(res.ok){const data=await res.json();setCaseData(data)}}));const es=new EventSource("/api/cases/stream");return es.onmessage=e=>{const data=JSON.parse(e.data);data.id===caseId&&(data.deleted?setCaseData(null):(setCaseData(data),sessionStorage.removeItem(`preview-${caseId}`)))},()=>es.close()}),[caseId]),(0,react.useEffect)((()=>{caseData&&(setPlate((0,caseUtils.qy)(caseData)||""),setPlateState((0,caseUtils.W7)(caseData)||""),setVin((0,caseUtils.E5)(caseData)||""),setSelectedPhoto((prev=>{var _caseData_threadImages;const all=new Set([...caseData.photos,...(null!==(_caseData_threadImages=caseData.threadImages)&&void 0!==_caseData_threadImages?_caseData_threadImages:[]).map((img=>img.url))]);return prev&&all.has(prev)?prev:(0,caseUtils.wq)(caseData)})))}),[caseData]),!caseData)return(0,jsx_runtime.jsxs)("div",{className:"p-8 flex flex-col gap-4",children:[(0,jsx_runtime.jsx)("h1",{className:"text-xl font-semibold",children:"Uploading..."}),preview?(0,jsx_runtime.jsx)("img",{src:preview,alt:"preview",className:"max-w-full"}):null,(0,jsx_runtime.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Uploading photo..."})]});const violationIdentified="complete"===caseData.analysisStatus&&(0,caseUtils.UO)(caseData.analysis),vinOverridden=null!==caseData.vinOverride,plateNumberOverridden=void 0!==(null===(_caseData_analysisOverrides=caseData.analysisOverrides)||void 0===_caseData_analysisOverrides||null===(_caseData_analysisOverrides_vehicle=_caseData_analysisOverrides.vehicle)||void 0===_caseData_analysisOverrides_vehicle?void 0:_caseData_analysisOverrides_vehicle.licensePlateNumber),plateStateOverridden=void 0!==(null===(_caseData_analysisOverrides1=caseData.analysisOverrides)||void 0===_caseData_analysisOverrides1||null===(_caseData_analysisOverrides_vehicle1=_caseData_analysisOverrides1.vehicle)||void 0===_caseData_analysisOverrides_vehicle1?void 0:_caseData_analysisOverrides_vehicle1.licensePlateState),ownerContact=(0,caseUtils.g_)(caseData),progress="pending"===caseData.analysisStatus&&caseData.analysisProgress?caseData.analysisProgress:null,progressDescription=progress?`${progress.steps?`Step ${progress.step} of ${progress.steps}: `:""}${"upload"===progress.stage?progress.index>0?`Uploading ${progress.index} of ${progress.total} photos (${Math.floor(progress.index/progress.total*100)}%)`:"Uploading photos...":progress.done?"Processing results...":`Analyzing... ${progress.received} of ${progress.total} tokens`}`:"pending"===caseData.analysisStatus?"Analyzing photo...":"canceled"===caseData.analysisStatus?"Analysis canceled.":"Analysis failed.",analysisBlock=caseData.analysis?(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(AnalysisInfo.A,{analysis:caseData.analysis,onPlateChange:async function updatePlateNumber(value){setPlate(value),await updateVehicle(value,plateState)},onStateChange:async function updatePlateStateFn(value){setPlateState(value),await updateVehicle(plate,value)},onClearPlate:plateNumberOverridden?async function clearPlateNumber(){setPlate(""),await updateVehicle("",plateState)}:void 0,onClearState:plateStateOverridden?async function clearPlateState(){setPlateState(""),await updateVehicle(plate,"")}:void 0})}):caseData.analysisError?(0,jsx_runtime.jsx)("p",{className:"text-sm text-red-600",children:"truncated"===caseData.analysisError?"Analysis failed because the AI response was cut off. Please try again.":"parse"===caseData.analysisError?"Analysis failed due to invalid JSON from the AI. Please try again.":"images"===caseData.analysisError?"Analysis failed because no images were provided or some photo files were missing.":"Analysis failed because the AI response did not match the expected format. Please retry."}):caseData.analysisStatusCode&&caseData.analysisStatusCode>=400?(0,jsx_runtime.jsx)("p",{className:"text-sm text-red-600",children:"Analysis failed. Please try again later."}):"canceled"===caseData.analysisStatus?(0,jsx_runtime.jsx)("p",{className:"text-sm text-red-600",children:"Analysis canceled."}):"pending"===caseData.analysisStatus&&progress?(0,jsx_runtime.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:progressDescription}):(0,jsx_runtime.jsx)("p",{className:"text-sm text-red-600",children:"Analysis failed."});var _caseData_analysis_images;const analysisImages=null!==(_caseData_analysis_images=null===(_caseData_analysis=caseData.analysis)||void 0===_caseData_analysis?void 0:_caseData_analysis.images)&&void 0!==_caseData_analysis_images?_caseData_analysis_images:{},evidencePhotos=caseData.photos.filter((p=>{var _analysisImages_baseName;return!(null===(_analysisImages_baseName=analysisImages[baseName(p)])||void 0===_analysisImages_baseName?void 0:_analysisImages_baseName.paperwork)})),paperworkPhotos=caseData.photos.filter((p=>{var _analysisImages_baseName;return null===(_analysisImages_baseName=analysisImages[baseName(p)])||void 0===_analysisImages_baseName?void 0:_analysisImages_baseName.paperwork}));var _caseData_threadImages;const paperworkScans=(null!==(_caseData_threadImages=caseData.threadImages)&&void 0!==_caseData_threadImages?_caseData_threadImages:[]).map((img=>({url:img.url,time:img.uploadedAt}))),allPaperwork=[...paperworkPhotos.map((p=>({url:p,time:caseData.photoTimes[p]}))),...paperworkScans],photoMenuRef=(0,react.useRef)(null);return useCloseOnOutsideClick(photoMenuRef),(0,jsx_runtime.jsxs)("div",{className:"relative h-full",onDragOver:e=>e.preventDefault(),onDragEnter:e=>{e.preventDefault(),setDragging(!0)},onDragLeave:e=>{e.currentTarget.contains(e.relatedTarget)||setDragging(!1)},onDrop:async e=>{e.preventDefault(),await uploadFiles(e.dataTransfer.files),setDragging(!1)},children:[(0,jsx_runtime.jsx)(CaseLayout,{header:(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(link_default(),{href:"/cases",className:"text-blue-500 underline md:hidden",children:"Back to Cases"}),(0,jsx_runtime.jsxs)("h1",{className:"text-xl font-semibold",children:["Case ",caseData.id]})]}),(0,jsx_runtime.jsx)(CaseToolbar,{caseId,disabled:!violationIdentified,hasOwner:Boolean(ownerContact),progress})]}),left:(0,jsx_runtime.jsx)(CaseProgressGraph,{caseData}),right:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"order-first bg-gray-100 dark:bg-gray-800 p-4 rounded flex flex-col gap-2 text-sm",children:[analysisBlock,ownerContact?(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Owner:"})," ",ownerContact]}):null,(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Created:"})," ",new Date(caseData.createdAt).toLocaleString()]}),caseData.streetAddress?(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Address:"})," ",caseData.streetAddress]}):null,caseData.intersection?(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Intersection:"})," ",caseData.intersection]}):null,(()=>{const g=(0,caseUtils.qR)(caseData);return g?(0,jsx_runtime.jsx)(MapPreview.A,{lat:g.lat,lon:g.lon,width:600,height:300,className:"w-full aspect-[2/1] md:max-w-xl",link:`https://www.google.com/maps?q=${caseData.gps.lat},${caseData.gps.lon}`}):null})(),(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"VIN:"})," ",(0,jsx_runtime.jsx)(EditableText.A,{value:vin,onSubmit:async function updateVinFn(value){setVin(value),(await fetch(`/api/cases/${caseId}/vin`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({vin:value||null})})).ok?await refreshCase():alert("Failed to update VIN.")},onClear:vinOverridden?async function clearVin(){setVin(""),(await fetch(`/api/cases/${caseId}/vin`,{method:"DELETE"})).ok?await refreshCase():alert("Failed to clear VIN.")}:void 0,placeholder:"VIN"})]})]}),selectedPhoto?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"relative w-full aspect-[3/2] md:max-w-2xl shrink-0",children:[(0,jsx_runtime.jsx)(next_image.A,{src:selectedPhoto,alt:"uploaded",fill:!0,className:"object-contain"}),(0,jsx_runtime.jsxs)("details",{ref:photoMenuRef,className:"absolute top-1 right-1 text-white",children:[(0,jsx_runtime.jsx)("summary",{className:"cursor-pointer select-none bg-black/40 rounded px-1 opacity-70",children:"⋮"}),(0,jsx_runtime.jsxs)("div",{className:"absolute right-0 mt-1 bg-white dark:bg-gray-900 border rounded shadow text-black dark:text-white",children:[(0,jsx_runtime.jsx)("button",{type:"button",onClick:e=>async function reanalyzePhoto(photo,detailsEl){const url=`/api/cases/${caseId}/reanalyze-photo?photo=${encodeURIComponent(photo)}`;caseData&&setCaseData({...caseData,analysisStatus:"pending"}),(await fetch(url,{method:"POST"})).ok?detailsEl&&(detailsEl.open=!1):alert("Failed to reanalyze photo."),await refreshCase()}(selectedPhoto,e.currentTarget.closest("details")),className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:"Reanalyze Photo"}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:()=>removePhoto(selectedPhoto),className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:"Delete Image"})]})]}),caseData.analysis?(0,jsx_runtime.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 bg-black/60 text-white p-2 space-y-1 text-sm",children:[(0,jsx_runtime.jsx)(ImageHighlights,{analysis:caseData.analysis,photo:selectedPhoto}),progress?(0,jsx_runtime.jsx)("p",{children:progressDescription}):null]}):(0,jsx_runtime.jsx)("div",{className:"absolute bottom-0 left-0 right-0 bg-black/60 text-white p-2 text-sm",children:progressDescription})]}),(()=>{const t=caseData.photoTimes[selectedPhoto];return t?(0,jsx_runtime.jsxs)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Taken ",new Date(t).toLocaleString()]}):null})()]}):null,(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 flex-wrap",children:[evidencePhotos.map((p=>(0,jsx_runtime.jsxs)("div",{className:"relative group",children:[(0,jsx_runtime.jsxs)("button",{type:"button",onClick:()=>setSelectedPhoto(p),className:selectedPhoto===p?"ring-2 ring-blue-500":"ring-1 ring-transparent",children:[(0,jsx_runtime.jsx)("div",{className:"relative w-20 aspect-[4/3]",children:(0,jsx_runtime.jsx)(next_image.A,{src:p,alt:"case photo",fill:!0,className:"object-cover"})}),(()=>{const t=caseData.photoTimes[p];return t?(0,jsx_runtime.jsx)("span",{className:"absolute bottom-1 left-1 bg-black/60 text-white text-xs rounded px-1",children:new Date(t).toLocaleDateString()}):null})()]}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:()=>removePhoto(p),className:"absolute -top-1 -right-1 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity",children:"×"})]},p))),(0,jsx_runtime.jsxs)("label",{className:"flex items-center justify-center border rounded w-20 aspect-[4/3] text-sm text-gray-500 dark:text-gray-400 cursor-pointer",children:["+ add image",(0,jsx_runtime.jsx)("input",{ref:fileInputRef,type:"file",accept:"image/*",multiple:!0,onChange:async function handleUpload(e){const files=e.target.files;files&&await uploadFiles(files)},className:"hidden"})]})]})]}),children:(0,jsx_runtime.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[caseData.sentEmails&&caseData.sentEmails.length>0?(0,jsx_runtime.jsxs)("div",{className:"bg-gray-100 dark:bg-gray-800 p-4 rounded flex flex-col gap-2",children:[(0,jsx_runtime.jsx)("h2",{className:"font-semibold",children:"Email Log"}),(0,jsx_runtime.jsx)("ul",{className:"flex flex-col gap-2 text-sm",children:buildThreads(caseData).map((mail=>(0,jsx_runtime.jsxs)("li",{id:`email-${mail.sentAt}`,className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsxs)("span",{children:[new Date(mail.sentAt).toLocaleString()," - ",mail.subject]}),(0,jsx_runtime.jsxs)("span",{className:"text-gray-500 dark:text-gray-400",children:["To: ",mail.to]}),(0,jsx_runtime.jsx)("span",{className:"text-gray-500 dark:text-gray-400 whitespace-pre-wrap",children:mail.body}),(0,jsx_runtime.jsx)("a",{href:`/cases/${caseId}/thread/${encodeURIComponent(mail.sentAt)}`,className:"self-start text-blue-500 underline",children:"View Thread"})]},mail.sentAt)))})]}):null,allPaperwork.length>0?(0,jsx_runtime.jsxs)("div",{className:"bg-gray-100 dark:bg-gray-800 p-4 rounded flex flex-col gap-2",children:[(0,jsx_runtime.jsx)("h2",{className:"font-semibold",children:"Paperwork"}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 flex-wrap",children:allPaperwork.map((({url,time})=>(0,jsx_runtime.jsx)("div",{className:"relative",children:(0,jsx_runtime.jsxs)("button",{type:"button",onClick:()=>setSelectedPhoto(url),className:selectedPhoto===url?"ring-2 ring-blue-500":"ring-1 ring-transparent",children:[(0,jsx_runtime.jsx)("div",{className:"relative w-20 aspect-[4/3]",children:(0,jsx_runtime.jsx)(next_image.A,{src:url,alt:"paperwork",fill:!0,className:"object-cover"})}),time?(0,jsx_runtime.jsx)("span",{className:"absolute bottom-1 left-1 bg-black/60 text-white text-xs rounded px-1",children:new Date(time).toLocaleDateString()}):null]})},url)))})]}):null]})}),dragging?(0,jsx_runtime.jsx)("div",{className:"absolute inset-0 bg-black/50 text-white flex items-center justify-center pointer-events-none text-xl z-10",children:"Drop to add photos"}):null]})}ClientCasePage.__docgenInfo={description:"",methods:[],displayName:"ClientCasePage",props:{initialCase:{required:!0,tsType:{name:"union",raw:"Case | null",elements:[{name:"Case"},{name:"null"}]},description:""},caseId:{required:!0,tsType:{name:"string"},description:""}}}}}]);