"use strict";(self.webpackChunkapp_scaffold=self.webpackChunkapp_scaffold||[]).push([[590],{"./src/app/cases/ClientCasesPage.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{MultipleCases:()=>MultipleCases,SelectedCase:()=>SelectedCase,__namedExportsOrder:()=>__namedExportsOrder,default:()=>ClientCasesPage_stories});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),MapPreview=__webpack_require__("./src/app/components/MapPreview.tsx"),next_image=__webpack_require__("./node_modules/@storybook/nextjs/dist/images/next-image.mjs"),navigation=__webpack_require__("./node_modules/@storybook/nextjs/dist/export-mocks/navigation/index.mjs"),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),caseUtils=__webpack_require__("./src/lib/caseUtils.ts");const WGS84_F=1/298.257223563;function toRad(deg){return deg*Math.PI/180}function distanceBetween(a,b){const L=toRad(b.lon-a.lon),U1=Math.atan((1-WGS84_F)*Math.tan(toRad(a.lat))),U2=Math.atan((1-WGS84_F)*Math.tan(toRad(b.lat))),sinU1=Math.sin(U1),cosU1=Math.cos(U1),sinU2=Math.sin(U2),cosU2=Math.cos(U2);let lambda=L,lambdaP=0,iter=0,cosSqAlpha=0,sinSigma=0,cosSigma=0,sigma=0,cos2SigmaM=0;do{const sinLambda=Math.sin(lambda),cosLambda=Math.cos(lambda);if(sinSigma=Math.sqrt((cosU2*sinLambda)**2+(cosU1*sinU2-sinU1*cosU2*cosLambda)**2),0===sinSigma)return 0;cosSigma=sinU1*sinU2+cosU1*cosU2*cosLambda,sigma=Math.atan2(sinSigma,cosSigma);const sinAlpha=cosU1*cosU2*sinLambda/sinSigma;cosSqAlpha=1-sinAlpha**2,cos2SigmaM=0!==cosSqAlpha?cosSigma-2*sinU1*sinU2/cosSqAlpha:0;const C=WGS84_F/16*cosSqAlpha*(4+WGS84_F*(4-3*cosSqAlpha));lambdaP=lambda,lambda=L+(1-C)*WGS84_F*sinAlpha*(sigma+C*sinSigma*(cos2SigmaM+C*cosSigma*(2*cos2SigmaM**2-1)))}while(Math.abs(lambda-lambdaP)>1e-12&&++iter<1e3);const uSq=272331606109.84375*cosSqAlpha/40408299984659.16,B=uSq/1024*(256+uSq*(uSq*(74-47*uSq)-128));return 6356752.314245*(1+uSq/16384*(4096+uSq*(uSq*(320-175*uSq)-768)))*(sigma-B*sinSigma*(cos2SigmaM+B/4*(cosSigma*(2*cos2SigmaM**2-1)-B/6*cos2SigmaM*(4*sinSigma**2-3)*(4*cos2SigmaM**2-3))))}var AnalysisInfo=__webpack_require__("./src/app/components/AnalysisInfo.tsx"),useNewCaseFromFiles=__webpack_require__("./src/app/useNewCaseFromFiles.ts"),useDragReset=__webpack_require__("./src/app/cases/useDragReset.ts");function sortList(list,key,location){if("distance"===key&&location)return[...list].sort(((a,b)=>{const ag=(0,caseUtils.qR)(a),bg=(0,caseUtils.qR)(b);return ag||bg?ag?bg?distanceBetween(location,ag)-distanceBetween(location,bg):-1:1:0}));const k=key;return[...list].sort(((a,b)=>{var _b_k,_a_k;return new Date(null!==(_b_k=b[k])&&void 0!==_b_k?_b_k:b.createdAt).getTime()-new Date(null!==(_a_k=a[k])&&void 0!==_a_k?_a_k:a.createdAt).getTime()}))}function ClientCasesPage({initialCases}){var _searchParams_get;const[orderBy,setOrderBy]=(0,react.useState)("createdAt"),[cases,setCases]=(0,react.useState)((()=>sortList(initialCases,"createdAt"))),[userLocation,setUserLocation]=(0,react.useState)(null),router=(0,navigation.useRouter)(),uploadNewCase=(0,useNewCaseFromFiles.A)(),[dragging,setDragging]=(0,react.useState)(!1),[dropCase,setDropCase]=(0,react.useState)(null),params=(0,navigation.useParams)();var _searchParams_get_split_filter;const selectedIds=null!==(_searchParams_get_split_filter=null===(_searchParams_get=(0,navigation.useSearchParams)().get("ids"))||void 0===_searchParams_get?void 0:_searchParams_get.split(",").filter(Boolean))&&void 0!==_searchParams_get_split_filter?_searchParams_get_split_filter:params.id?[params.id]:[];return(0,react.useEffect)((()=>{const es=new EventSource("/api/cases/stream");return es.onmessage=e=>{const data=JSON.parse(e.data);setCases((prev=>{if(data.deleted)return sortList(prev.filter((c=>c.id!==data.id)),orderBy,userLocation);const idx=prev.findIndex((c=>c.id===data.id));if(-1===idx)return sortList([...prev,data],orderBy,userLocation);const copy=[...prev];return copy[idx]=data,sortList(copy,orderBy,userLocation)}))},()=>es.close()}),[orderBy,userLocation]),(0,react.useEffect)((()=>{setCases((prev=>sortList(prev,orderBy,userLocation)))}),[orderBy,userLocation]),(0,react.useEffect)((()=>{"distance"===orderBy&&!userLocation&&navigator.geolocation&&navigator.geolocation.getCurrentPosition((pos=>{setUserLocation({lat:pos.coords.latitude,lon:pos.coords.longitude})}))}),[orderBy,userLocation]),(0,useDragReset.A)((()=>{setDragging(!1),setDropCase(null)})),(0,jsx_runtime.jsxs)("div",{className:"p-8 relative h-full",onDragOver:e=>e.preventDefault(),onDragEnter:e=>{e.preventDefault(),setDragging(!0)},onDragLeave:e=>{e.currentTarget.contains(e.relatedTarget)||(setDragging(!1),setDropCase(null))},onDrop:async e=>{e.preventDefault();const files=e.dataTransfer.files;dropCase?await async function uploadFilesToCase(id,files){(await Promise.all(Array.from(files).map((file=>{const formData=new FormData;return formData.append("photo",file),formData.append("caseId",id),fetch("/api/upload",{method:"POST",body:formData})})))).some((r=>!r.ok))&&alert("Failed to upload one or more files.")}(dropCase,files):await uploadNewCase(files),setDragging(!1),setDropCase(null)},children:[(0,jsx_runtime.jsx)("h1",{className:"text-xl font-bold mb-4",children:"Cases"}),(0,jsx_runtime.jsxs)("div",{className:"mb-4",children:[(0,jsx_runtime.jsx)("label",{className:"mr-2",htmlFor:"order",children:"Order by:"}),(0,jsx_runtime.jsxs)("select",{id:"order",value:orderBy,onChange:e=>setOrderBy(e.target.value),className:"border rounded p-1 bg-white dark:bg-gray-900",children:[(0,jsx_runtime.jsx)("option",{value:"createdAt",children:"Creation Date"}),(0,jsx_runtime.jsx)("option",{value:"updatedAt",children:"Last Updated"}),(0,jsx_runtime.jsx)("option",{value:"distance",children:"Distance from My Location"})]})]}),(0,jsx_runtime.jsx)("ul",{className:"grid gap-4",children:cases.map((c=>(0,jsx_runtime.jsx)("li",{onDragEnter:()=>{setDropCase(c.id),setDragging(!0)},onDragLeave:e=>{e.currentTarget.contains(e.relatedTarget)||setDropCase(null)},className:"border p-2 "+(selectedIds.includes(c.id)?"bg-gray-100 dark:bg-gray-800 ring-2 ring-blue-500":dropCase===c.id?"ring-2 ring-green-500":"ring-1 ring-transparent"),children:(0,jsx_runtime.jsxs)("button",{type:"button",onClick:e=>{if(e.shiftKey){const ids=Array.from(new Set([...selectedIds,c.id]));router.push(`/cases?ids=${ids.join(",")}`)}else router.push(`/cases/${c.id}`)},className:"flex items-start gap-4 w-full text-left",children:[(0,jsx_runtime.jsxs)("div",{className:"relative",children:[(0,jsx_runtime.jsx)(next_image.A,{src:(0,caseUtils.wq)(c),alt:"case thumbnail",width:80,height:60}),c.photos.length>1?(0,jsx_runtime.jsx)("span",{className:"absolute bottom-1 right-1 bg-black bg-opacity-75 text-white text-xs rounded px-1",children:c.photos.length}):null]}),(()=>{const g=(0,caseUtils.qR)(c);return g?(0,jsx_runtime.jsx)(MapPreview.A,{lat:g.lat,lon:g.lon,width:80,height:60,className:"w-20 aspect-[4/3]"}):null})(),(0,jsx_runtime.jsxs)("div",{className:"flex flex-col text-sm gap-1",children:[(0,jsx_runtime.jsxs)("span",{className:"font-semibold",children:["Case ",c.id]}),c.analysis?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(AnalysisInfo.A,{analysis:c.analysis}),"pending"===c.analysisStatus?(0,jsx_runtime.jsx)("span",{className:"text-gray-500 dark:text-gray-400",children:"Updating analysis..."}):null]}):(0,jsx_runtime.jsx)("span",{className:"text-gray-500 dark:text-gray-400",children:"Analyzing photo..."})]})]})},c.id)))}),dragging?(0,jsx_runtime.jsx)("div",{className:"absolute inset-0 bg-black/50 text-white flex items-center justify-center pointer-events-none text-xl z-10",children:dropCase?`Add photos to case ${dropCase}`:"Drop photos to create case"}):null]})}ClientCasesPage.__docgenInfo={description:"",methods:[],displayName:"ClientCasesPage",props:{initialCases:{required:!0,tsType:{name:"Array",elements:[{name:"Case"}],raw:"Case[]"},description:""}}};const ClientCasesPage_stories={component:ClientCasesPage,title:"Pages/ClientCasesPage"},caseBase={photos:["https://placehold.co/600x400?text=photo"],photoTimes:{},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),gps:{lat:41.88,lon:-87.78},streetAddress:null,intersection:null,vin:null,vinOverride:null,analysis:null,analysisOverrides:null,analysisStatus:"pending",analysisStatusCode:null,sentEmails:[],ownershipRequests:[]},MultipleCases={render:()=>{const cases=[{id:"1",...caseBase,analysis:{violationType:"parking",details:"Blocking sidewalk",vehicle:{licensePlateNumber:"ABC123"},location:"Oak Park",images:{}},analysisStatus:"complete"},{id:"2",...caseBase,photos:["https://placehold.co/600x400?text=photo2","https://placehold.co/601x400?text=photo3"]}];return(0,jsx_runtime.jsx)(ClientCasesPage,{initialCases:cases})}},SelectedCase={render:()=>{const cases=[{id:"1",...caseBase},{id:"2",...caseBase}];return(0,jsx_runtime.jsx)(ClientCasesPage,{initialCases:cases})}},__namedExportsOrder=["MultipleCases","SelectedCase"];MultipleCases.parameters={...MultipleCases.parameters,docs:{...MultipleCases.parameters?.docs,source:{originalSource:'{\n  render: () => {\n    const cases: Case[] = [{\n      id: "1",\n      ...caseBase,\n      analysis: {\n        violationType: "parking",\n        details: "Blocking sidewalk",\n        vehicle: {\n          licensePlateNumber: "ABC123"\n        },\n        location: "Oak Park",\n        images: {}\n      },\n      analysisStatus: "complete"\n    }, {\n      id: "2",\n      ...caseBase,\n      photos: ["https://placehold.co/600x400?text=photo2", "https://placehold.co/601x400?text=photo3"]\n    }];\n    return <ClientCasesPage initialCases={cases} />;\n  }\n}',...MultipleCases.parameters?.docs?.source}}},SelectedCase.parameters={...SelectedCase.parameters,docs:{...SelectedCase.parameters?.docs,source:{originalSource:'{\n  render: () => {\n    const cases: Case[] = [{\n      id: "1",\n      ...caseBase\n    }, {\n      id: "2",\n      ...caseBase\n    }];\n    return <ClientCasesPage initialCases={cases} />;\n  }\n}',...SelectedCase.parameters?.docs?.source}}}},"./src/app/useNewCaseFromFiles.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>useNewCaseFromFiles});var next_navigation__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@storybook/nextjs/dist/export-mocks/navigation/index.mjs");function useNewCaseFromFiles(){const router=(0,next_navigation__WEBPACK_IMPORTED_MODULE_0__.useRouter)();return async files=>{if(!files||0===files.length)return;const id=Date.now().toString(),preview=URL.createObjectURL(files[0]);sessionStorage.setItem(`preview-${id}`,preview);(await Promise.all(Array.from(files).map(((file,idx)=>{const formData=new FormData;formData.append("photo",file),formData.append("caseId",id);const upload=fetch("/api/upload",{method:"POST",body:formData});return 0===idx&&upload.then((()=>{sessionStorage.removeItem(`preview-${id}`)})),upload})))).some((r=>!r.ok))?alert("Failed to upload one or more files."):router.push(`/cases/${id}`)}}}}]);