"use strict";(self.webpackChunkapp_scaffold=self.webpackChunkapp_scaffold||[]).push([[2581],{"./src/app/cases/[id]/components/PhotoViewer.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>PhotoViewer});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),EditableText=__webpack_require__("./src/app/components/EditableText.tsx");function ImageHighlights({analysis,photo}){var _analysis_images;const name=photo.split("/").pop()||photo,info=null===(_analysis_images=analysis.images)||void 0===_analysis_images?void 0:_analysis_images[name];return info?(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1 text-sm",children:[(0,jsx_runtime.jsxs)("span",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Image score:"})," ",info.representationScore.toFixed(2)]}),info.highlights?(0,jsx_runtime.jsx)("span",{children:info.highlights}):null,info.context?(0,jsx_runtime.jsx)("span",{children:info.context}):null]}):null}ImageHighlights.__docgenInfo={description:"",methods:[],displayName:"ImageHighlights",props:{analysis:{required:!0,tsType:{name:"ViolationReport"},description:""},photo:{required:!0,tsType:{name:"string"},description:""}}};var next_image=__webpack_require__("./node_modules/@storybook/nextjs/dist/images/next-image.mjs"),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js");function constrainPan(container,natural,t){if(!container||!natural)return t;const ratio=natural.width/natural.height;let baseWidth,baseHeight;ratio>container.width/container.height?(baseWidth=container.width,baseHeight=container.width/ratio):(baseHeight=container.height,baseWidth=container.height*ratio);const width=baseWidth*t.scale,height=baseHeight*t.scale,extraX=container.width-width,extraY=container.height-height,minX=extraX>=0?extraX/2:extraX,maxX=extraX>=0?extraX/2:0,minY=extraY>=0?extraY/2:extraY,maxY=extraY>=0?extraY/2:0;return{scale:t.scale,x:Math.min(maxX,Math.max(minX,t.x)),y:Math.min(maxY,Math.max(minY,t.y))}}function ZoomableImage({src,alt}){const containerRef=(0,react.useRef)(null),[transform,setTransform]=(0,react.useState)({scale:1,x:0,y:0}),imgRef=(0,react.useRef)(null),[naturalSize,setNaturalSize]=(0,react.useState)(),pointers=(0,react.useRef)(new Map),lastDistance=(0,react.useRef)(null),lastCenter=(0,react.useRef)(null);function handlePointerUp(e){pointers.current.delete(e.pointerId),pointers.current.size<2&&(lastDistance.current=null,lastCenter.current=null)}const handleWheel=(0,react.useCallback)(e=>{var _containerRef_current;e.preventDefault();const rect=null===(_containerRef_current=containerRef.current)||void 0===_containerRef_current?void 0:_containerRef_current.getBoundingClientRect();if(!rect)return;const cursorX=e.clientX-rect.left,cursorY=e.clientY-rect.top,zoom=Math.exp(-e.deltaY/200);setTransform(t=>{const scale=Math.min(5,Math.max(1,t.scale*zoom)),originX=(cursorX-t.x)/t.scale,originY=(cursorY-t.y)/t.scale,x=t.x-(scale-t.scale)*originX,y=t.y-(scale-t.scale)*originY;return constrainPan(rect,naturalSize,{scale,x,y})})},[naturalSize]);return(0,react.useEffect)(()=>{const el=containerRef.current;if(el)return el.addEventListener("wheel",handleWheel,{passive:!1}),()=>{el.removeEventListener("wheel",handleWheel)}},[handleWheel]),(0,jsx_runtime.jsx)("div",{ref:containerRef,className:"w-full h-full relative overflow-hidden touch-none",onPointerDown:function handlePointerDown(e){e.currentTarget.setPointerCapture(e.pointerId),pointers.current.set(e.pointerId,{x:e.clientX,y:e.clientY})},onPointerMove:function handlePointerMove(e){if(!pointers.current.has(e.pointerId))return;const prev=pointers.current.get(e.pointerId);if(!prev)return;const cur={x:e.clientX,y:e.clientY};if(pointers.current.set(e.pointerId,cur),2===pointers.current.size){var _lastCenter_current,_lastCenter_current1;const[p1,p2]=Array.from(pointers.current.values()),center={x:(p1.x+p2.x)/2,y:(p1.y+p2.y)/2},dist=Math.hypot(p1.x-p2.x,p1.y-p2.y);if(null===lastDistance.current)return lastDistance.current=dist,void(lastCenter.current=center);const scaleDelta=dist/lastDistance.current;var _lastCenter_current_x;lastDistance.current=dist;const dx=center.x-(null!==(_lastCenter_current_x=null===(_lastCenter_current=lastCenter.current)||void 0===_lastCenter_current?void 0:_lastCenter_current.x)&&void 0!==_lastCenter_current_x?_lastCenter_current_x:center.x);var _lastCenter_current_y;const dy=center.y-(null!==(_lastCenter_current_y=null===(_lastCenter_current1=lastCenter.current)||void 0===_lastCenter_current1?void 0:_lastCenter_current1.y)&&void 0!==_lastCenter_current_y?_lastCenter_current_y:center.y);lastCenter.current=center,setTransform(t=>{var _containerRef_current;const scale=Math.min(5,Math.max(1,t.scale*scaleDelta)),rect=null===(_containerRef_current=containerRef.current)||void 0===_containerRef_current?void 0:_containerRef_current.getBoundingClientRect();if(!rect)return t;const originX=(center.x-rect.left-t.x)/t.scale,originY=(center.y-rect.top-t.y)/t.scale,x=t.x-(scale-t.scale)*originX+dx,y=t.y-(scale-t.scale)*originY+dy;return constrainPan(rect,naturalSize,{scale,x,y})})}else if(1===pointers.current.size&&null===lastDistance.current){const dx=cur.x-prev.x,dy=cur.y-prev.y;setTransform(t=>{var _containerRef_current;return constrainPan(null===(_containerRef_current=containerRef.current)||void 0===_containerRef_current?void 0:_containerRef_current.getBoundingClientRect(),naturalSize,{scale:t.scale,x:t.x+dx,y:t.y+dy})})}},onPointerUp:handlePointerUp,onPointerCancel:handlePointerUp,children:(0,jsx_runtime.jsx)(next_image.A,{src,alt,fill:!0,unoptimized:!0,ref:imgRef,onLoadingComplete:img=>setNaturalSize({width:img.naturalWidth,height:img.naturalHeight}),draggable:!1,className:"object-contain select-none",style:{transform:`translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`,transformOrigin:"0 0"}})})}ZoomableImage.__docgenInfo={description:"",methods:[],displayName:"ZoomableImage",props:{src:{required:!0,tsType:{name:"string"},description:""},alt:{required:!0,tsType:{name:"string"},description:""}}};var useCloseOnOutsideClick=__webpack_require__("./src/app/useCloseOnOutsideClick.ts"),ui_progress=__webpack_require__("./src/components/ui/progress.tsx");function PhotoViewer({caseData,selectedPhoto,progress,progressDescription,requestValue,isPhotoReanalysis,reanalyzingPhoto,analysisActive,readOnly,photoNote,updatePhotoNote,removePhoto,reanalyzePhoto}){const photoMenuRef=(0,react.useRef)(null);(0,useCloseOnOutsideClick.A)(photoMenuRef);const t=caseData.photoTimes[selectedPhoto];return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"relative w-full aspect-[3/2] md:max-w-2xl shrink-0",children:[(0,jsx_runtime.jsx)(ZoomableImage,{src:selectedPhoto,alt:"uploaded"}),isPhotoReanalysis&&reanalyzingPhoto===selectedPhoto?(0,jsx_runtime.jsx)("div",{className:"absolute top-0 left-0 right-0",children:(0,jsx_runtime.jsx)(ui_progress.k,{value:requestValue,indeterminate:void 0===requestValue})}):null,readOnly?null:(0,jsx_runtime.jsxs)("details",{ref:photoMenuRef,className:"absolute top-1 right-1 text-white",onToggle:()=>{var _photoMenuRef_current,_photoMenuRef_current_querySelector;(null===(_photoMenuRef_current=photoMenuRef.current)||void 0===_photoMenuRef_current?void 0:_photoMenuRef_current.open)&&(null===(_photoMenuRef_current_querySelector=photoMenuRef.current.querySelector("button, a"))||void 0===_photoMenuRef_current_querySelector||_photoMenuRef_current_querySelector.focus())},children:[(0,jsx_runtime.jsx)("summary",{className:"cursor-pointer select-none bg-black/40 rounded px-1 opacity-70","aria-label":"Photo actions menu",children:"⋮"}),(0,jsx_runtime.jsxs)("div",{className:"absolute right-0 mt-1 bg-white dark:bg-gray-900 border rounded shadow text-black dark:text-white",role:"menu",children:[(0,jsx_runtime.jsx)("button",{type:"button",onClick:e=>reanalyzePhoto(selectedPhoto,e.currentTarget.closest("details")),className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",disabled:"pending"===caseData.analysisStatus&&analysisActive,children:"Reanalyze Photo"}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:()=>removePhoto(selectedPhoto),className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:"Delete Image"})]})]}),caseData.analysis?(0,jsx_runtime.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 bg-black/60 text-white p-2 space-y-1 text-sm",children:[(0,jsx_runtime.jsx)(ImageHighlights,{analysis:caseData.analysis,photo:selectedPhoto}),progress?(0,jsx_runtime.jsx)("p",{children:progressDescription}):null]}):(0,jsx_runtime.jsx)("div",{className:"absolute bottom-0 left-0 right-0 bg-black/60 text-white p-2 text-sm",children:progressDescription})]}),t?(0,jsx_runtime.jsxs)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Taken ",new Date(t).toLocaleString()]}):null,(0,jsx_runtime.jsxs)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Note:"})," ",readOnly?(0,jsx_runtime.jsx)("span",{children:photoNote||""}):(0,jsx_runtime.jsx)(EditableText.A,{value:photoNote,onSubmit:updatePhotoNote,onClear:photoNote?()=>updatePhotoNote(""):void 0,placeholder:"Add note"})]})]})}PhotoViewer.__docgenInfo={description:"",methods:[],displayName:"PhotoViewer",props:{caseData:{required:!0,tsType:{name:"Case"},description:""},selectedPhoto:{required:!0,tsType:{name:"string"},description:""},progress:{required:!0,tsType:{name:"union",raw:"LlmProgress | null",elements:[{name:"union",raw:'| {\n    stage: "upload";\n    index: number;\n    total: number;\n    step?: number;\n    steps?: number;\n  }\n| {\n    stage: "stream";\n    received: number;\n    total: number;\n    done: boolean;\n    step?: number;\n    steps?: number;\n  }',elements:[{name:"signature",type:"object",raw:'{\n  stage: "upload";\n  index: number;\n  total: number;\n  step?: number;\n  steps?: number;\n}',signature:{properties:[{key:"stage",value:{name:"literal",value:'"upload"',required:!0}},{key:"index",value:{name:"number",required:!0}},{key:"total",value:{name:"number",required:!0}},{key:"step",value:{name:"number",required:!1}},{key:"steps",value:{name:"number",required:!1}}]}},{name:"signature",type:"object",raw:'{\n  stage: "stream";\n  received: number;\n  total: number;\n  done: boolean;\n  step?: number;\n  steps?: number;\n}',signature:{properties:[{key:"stage",value:{name:"literal",value:'"stream"',required:!0}},{key:"received",value:{name:"number",required:!0}},{key:"total",value:{name:"number",required:!0}},{key:"done",value:{name:"boolean",required:!0}},{key:"step",value:{name:"number",required:!1}},{key:"steps",value:{name:"number",required:!1}}]}}]},{name:"null"}]},description:""},progressDescription:{required:!0,tsType:{name:"string"},description:""},requestValue:{required:!0,tsType:{name:"union",raw:"number | undefined",elements:[{name:"number"},{name:"undefined"}]},description:""},isPhotoReanalysis:{required:!0,tsType:{name:"boolean"},description:""},reanalyzingPhoto:{required:!0,tsType:{name:"union",raw:"string | null",elements:[{name:"string"},{name:"null"}]},description:""},analysisActive:{required:!0,tsType:{name:"boolean"},description:""},readOnly:{required:!0,tsType:{name:"boolean"},description:""},photoNote:{required:!0,tsType:{name:"string"},description:""},updatePhotoNote:{required:!0,tsType:{name:"signature",type:"function",raw:"(value: string) => Promise<void>",signature:{arguments:[{type:{name:"string"},name:"value"}],return:{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"}}},description:""},removePhoto:{required:!0,tsType:{name:"signature",type:"function",raw:"(photo: string) => Promise<void>",signature:{arguments:[{type:{name:"string"},name:"photo"}],return:{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"}}},description:""},reanalyzePhoto:{required:!0,tsType:{name:"signature",type:"function",raw:"(\n  photo: string,\n  detailsEl?: HTMLDetailsElement | null,\n) => Promise<void>",signature:{arguments:[{type:{name:"string"},name:"photo"},{type:{name:"union",raw:"HTMLDetailsElement | null",elements:[{name:"HTMLDetailsElement"},{name:"null"}]},name:"detailsEl"}],return:{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"}}},description:""}}}},"./src/app/components/EditableText.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>EditableText});var react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/next/dist/compiled/react/index.js");function EditableText({value,onSubmit,onClear,placeholder,options}){const[editing,setEditing]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)(!1),[text,setText]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)(value),inputRef=(0,react__WEBPACK_IMPORTED_MODULE_1__.useRef)(null),listId=(0,react__WEBPACK_IMPORTED_MODULE_1__.useId)();return(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{setText(value)},[value]),editing?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.Fragment,{children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("input",{ref:inputRef,type:"text",value:text,placeholder,list:options?listId:void 0,onChange:e=>setText(e.target.value),onBlur:async function finish(){setEditing(!1),text!==value&&await onSubmit(text)},onKeyDown:e=>{"Enter"===e.key&&e.currentTarget.blur()},className:"border p-1 text-sm"}),options?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("datalist",{id:listId,children:options.map(o=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("option",{value:o},o))}):null]}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("span",{children:value||placeholder}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("button",{type:"button",onClick:function start(){setEditing(!0),setTimeout(()=>{var _inputRef_current,_inputRef_current1;null===(_inputRef_current=inputRef.current)||void 0===_inputRef_current||_inputRef_current.focus(),null===(_inputRef_current1=inputRef.current)||void 0===_inputRef_current1||_inputRef_current1.select()},0)},className:"text-gray-500 dark:text-gray-400",children:"✎"}),onClear&&value?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("button",{type:"button",onClick:onClear,className:"text-gray-500 dark:text-gray-400",children:"×"}):null]})}EditableText.__docgenInfo={description:"",methods:[],displayName:"EditableText",props:{value:{required:!0,tsType:{name:"string"},description:""},onSubmit:{required:!0,tsType:{name:"signature",type:"function",raw:"(v: string) => Promise<void> | void",signature:{arguments:[{type:{name:"string"},name:"v"}],return:{name:"union",raw:"Promise<void> | void",elements:[{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"},{name:"void"}]}}},description:""},onClear:{required:!1,tsType:{name:"signature",type:"function",raw:"() => Promise<void> | void",signature:{arguments:[],return:{name:"union",raw:"Promise<void> | void",elements:[{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"},{name:"void"}]}}},description:""},placeholder:{required:!1,tsType:{name:"string"},description:""},options:{required:!1,tsType:{name:"unknown"},description:""}}}},"./src/app/useCloseOnOutsideClick.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>useCloseOnOutsideClick});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/next/dist/compiled/react/index.js");function useCloseOnOutsideClick(ref){(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)(()=>{function handleClick(e){const el=ref.current;(null==el?void 0:el.open)&&e.target instanceof Node&&!el.contains(e.target)&&el.removeAttribute("open")}function handleKey(e){const el=ref.current;"Escape"===e.key&&(null==el?void 0:el.open)&&el.removeAttribute("open")}return document.addEventListener("click",handleClick),document.addEventListener("keydown",handleKey),()=>{document.removeEventListener("click",handleClick),document.removeEventListener("keydown",handleKey)}},[ref])}},"./src/components/ui/progress.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{k:()=>Progress});var react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),_radix_ui_react_progress__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@radix-ui/react-progress/dist/index.mjs");const Progress=__webpack_require__("./node_modules/next/dist/compiled/react/index.js").forwardRef(({value,indeterminate,className,...props},ref)=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(_radix_ui_react_progress__WEBPACK_IMPORTED_MODULE_2__.bL,{ref,className:`relative h-2 w-full overflow-hidden rounded-full bg-gray-300 dark:bg-gray-700 ${null!=className?className:""}`,...props,children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(_radix_ui_react_progress__WEBPACK_IMPORTED_MODULE_2__.C1,{className:"h-full w-full bg-blue-600 transition-transform "+(indeterminate?"animate-progress":""),style:{transform:`translateX(-${100-(null!=value?value:0)}%)`}})}));Progress.displayName="Progress",Progress.__docgenInfo={description:"",methods:[],displayName:"Progress",props:{value:{required:!1,tsType:{name:"number"},description:""},indeterminate:{required:!1,tsType:{name:"boolean"},description:""}}}}}]);