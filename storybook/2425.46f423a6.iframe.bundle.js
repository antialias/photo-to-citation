"use strict";(self.webpackChunkapp_scaffold=self.webpackChunkapp_scaffold||[]).push([[2425],{"./.storybook/MapPreviewStub.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>MapPreviewStub});var react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js");function MapPreviewStub({width,height,className}){return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("div",{className:null!=className?className:"",style:{aspectRatio:`${width} / ${height}`},children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("img",{src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='150'%3E%3Crect width='100%25' height='100%25' fill='%23ddd'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23666' font-family='sans-serif' font-size='20'%3EMap Preview%3C/text%3E%3C/svg%3E",alt:"Map preview placeholder",width,height,loading:"lazy"})})}MapPreviewStub.__docgenInfo={description:"",methods:[],displayName:"MapPreviewStub",props:{width:{required:!0,tsType:{name:"number"},description:""},height:{required:!0,tsType:{name:"number"},description:""},className:{required:!1,tsType:{name:"string"},description:""}}}},"./src/app/cases/[id]/ClientCasePage.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>ClientCasePageWithProvider});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),CaseChat=__webpack_require__("./src/app/cases/[id]/CaseChat.tsx"),useDragReset=__webpack_require__("./src/app/cases/useDragReset.ts");function CaseLayout({header,left,right,children}){return(0,jsx_runtime.jsxs)("div",{className:"p-8 flex flex-col gap-4",children:[(0,jsx_runtime.jsx)("div",{className:"sticky top-0 bg-white dark:bg-gray-900 z-sticky",children:header}),(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[35%_65%] lg:grid-cols-[30%_70%] gap-4 md:gap-6",children:[(0,jsx_runtime.jsx)("div",{children:left}),(0,jsx_runtime.jsx)("div",{className:"flex flex-col gap-4",children:right})]}),children]})}CaseLayout.__docgenInfo={description:"",methods:[],displayName:"CaseLayout",props:{header:{required:!0,tsType:{name:"ReactNode"},description:""},left:{required:!0,tsType:{name:"ReactNode"},description:""},right:{required:!0,tsType:{name:"ReactNode"},description:""},children:{required:!1,tsType:{name:"ReactNode"},description:""}}};var caseUtils=__webpack_require__("./src/lib/caseUtils.ts"),floating_ui_dom=__webpack_require__("./node_modules/@floating-ui/dom/dist/floating-ui.dom.mjs"),dynamic=__webpack_require__("./node_modules/next/dynamic.js"),dynamic_default=__webpack_require__.n(dynamic),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),es=__webpack_require__("./node_modules/react-i18next/dist/es/index.js");const UPLOADED_PREVIEW_COUNT=4,Mermaid=dynamic_default()(()=>Promise.all([__webpack_require__.e(1425),__webpack_require__.e(4508)]).then(__webpack_require__.bind(__webpack_require__,"./node_modules/react-mermaid2/dist/Mermaid.js")),{loadableGenerated:{webpack:()=>["./node_modules/react-mermaid2/dist/Mermaid.js"]},ssr:!1}),allSteps=[{id:"uploaded",key:"progress.uploaded"},{id:"analysis",key:"progress.analysis"},{id:"violation",key:"progress.violation"},{id:"noviol",key:"progress.noviol"},{id:"plate",key:"progress.plate"},{id:"vin",key:"progress.vin"},{id:"ownreq",key:"progress.ownreq"},{id:"own",key:"progress.own"},{id:"ownnotify",key:"progress.ownnotify"},{id:"notify",key:"progress.notify"},{id:"confirm",key:"progress.confirm"},{id:"sent",key:"progress.sent"},{id:"received",key:"progress.received"}];function CaseProgressGraph({caseData}){const{t}=(0,es.Bd)(),analysisDone="complete"===caseData.analysisStatus,violation=analysisDone&&(0,caseUtils.u5)(caseData),noviolation=analysisDone&&!violation,analysisPending="pending"===caseData.analysisStatus&&!caseData.analysis&&caseData.analysisProgress,reanalysisPending="pending"===caseData.analysisStatus&&Boolean(caseData.analysis)&&caseData.analysisProgress,steps=(0,react.useMemo)(()=>{const translated=allSteps.map(s=>({id:s.id,label:t(s.key)}));return noviolation?translated.filter(s=>["uploaded","analysis","noviol"].includes(s.id)):translated.filter(s=>"noviol"!==s.id)},[noviolation,t]),status=(0,react.useMemo)(()=>({uploaded:!0,analysis:analysisDone,violation,noviol:noviolation,plate:violation&&Boolean((0,caseUtils.qy)(caseData)||(0,caseUtils.W7)(caseData)),vin:violation&&Boolean((0,caseUtils.E5)(caseData)),ownreq:Boolean(caseData.ownershipRequests&&caseData.ownershipRequests.length>0),own:Boolean((0,caseUtils.g_)(caseData)),ownnotify:Boolean((()=>{const info=(0,caseUtils.sC)(caseData);var _caseData_sentEmails;return!!(null==info?void 0:info.email)&&(null!==(_caseData_sentEmails=caseData.sentEmails)&&void 0!==_caseData_sentEmails?_caseData_sentEmails:[]).some(m=>m.to===info.email)})()),notify:Boolean(caseData.sentEmails&&caseData.sentEmails.length>0),confirm:!1,sent:!1,received:!1}),[analysisDone,violation,noviolation,caseData]),firstPending=steps.findIndex(s=>!status[s.id]),[isDark,setIsDark]=(0,react.useState)(!1);(0,react.useEffect)(()=>{const mql=window.matchMedia("(prefers-color-scheme: dark)");setIsDark(mql.matches);const listener=e=>setIsDark(e.matches);return mql.addEventListener("change",listener),()=>mql.removeEventListener("change",listener)},[]);const chart=(0,react.useMemo)(()=>{var _caseData_sentEmails;const nodes=steps.map(s=>`${s.id}["${s.label}"]`).join("\n"),edgesList=[];edgesList.push(["uploaded","analysis",!0,analysisPending?t("progressEdges.analysisRequested"):null]),reanalysisPending&&edgesList.push(["analysis","analysis",!0,t("progressEdges.reanalysisRequested")]),noviolation?edgesList.push(["analysis","noviol",!0,t("progressEdges.noViolation")]):(edgesList.push(["analysis","violation",!0,t("progressEdges.evaluating")]),edgesList.push(["violation","plate",!0,t("progressEdges.detectingPlate")]),edgesList.push(["plate","vin",!1,t("progressEdges.decodingVin")]),edgesList.push(["plate","ownreq",!0,t("progressEdges.requestingOwnership")]),edgesList.push(["vin","ownreq",!1,t("progressEdges.lookupOwnership")]),edgesList.push(["ownreq","own",!0,t("progressEdges.awaitingOwnershipInfo")]),edgesList.push(["own","ownnotify",!0,t("progressEdges.notifyingOwner")]),edgesList.push(["violation","notify",!0,t("progressEdges.notifyingAuthorities")]),edgesList.push(["notify","confirm",!0,t("progressEdges.awaitingAuthorityResponse")]),edgesList.push(["confirm","sent",!0,t("progressEdges.citationProcessing")]),edgesList.push(["sent","received",!0,t("progressEdges.awaitingDelivery")]));const activeFromIdx=firstPending>0?firstPending-1:-1;let activeFrom=activeFromIdx>=0?steps[activeFromIdx].id:null;const activeTo=firstPending>=0?steps[firstPending].id:null;reanalysisPending&&(activeFrom="analysis");const edges=edgesList.map(([a,b,hard,label])=>`${a}${hard?"--\x3e":"-.->"}${label&&a===activeFrom&&b===activeTo?`|${label}|`:""}${b}`).join("\n"),classAssignments=steps.map((s,i)=>{const cls=status[s.id]?"completed":i===firstPending?"current":"pending";return`class ${s.id} ${cls}`}).join("\n"),platePhoto=(()=>{var _caseData_analysis;const plate=(0,caseUtils.qy)(caseData);if(!plate||!(null===(_caseData_analysis=caseData.analysis)||void 0===_caseData_analysis?void 0:_caseData_analysis.images))return caseData.photos[0]?`/uploads/${caseData.photos[0]}`:null;for(const[name,info]of Object.entries(caseData.analysis.images)){var _caseData_analysis1,_info_highlights,_info_paperworkInfo_vehicle,_info_paperworkInfo,_caseData_analysis_language,_info_highlights1,_info_highlights_,_ref;const hi="string"==typeof info.highlights?info.highlights:null!==(_ref=null!==(_info_highlights_=null===(_info_highlights=info.highlights)||void 0===_info_highlights?void 0:_info_highlights[null!==(_caseData_analysis_language=null===(_caseData_analysis1=caseData.analysis)||void 0===_caseData_analysis1?void 0:_caseData_analysis1.language)&&void 0!==_caseData_analysis_language?_caseData_analysis_language:"en"])&&void 0!==_info_highlights_?_info_highlights_:Object.values(null!==(_info_highlights1=info.highlights)&&void 0!==_info_highlights1?_info_highlights1:{})[0])&&void 0!==_ref?_ref:"";if((null===(_info_paperworkInfo=info.paperworkInfo)||void 0===_info_paperworkInfo||null===(_info_paperworkInfo_vehicle=_info_paperworkInfo.vehicle)||void 0===_info_paperworkInfo_vehicle?void 0:_info_paperworkInfo_vehicle.licensePlateNumber)===plate||hi.toLowerCase().includes("plate")){const file=caseData.photos.find(p=>p.split("/").pop()===name);if(file)return`/uploads/${file}`}}return caseData.photos[0]?`/uploads/${caseData.photos[0]}`:null})();var _caseData_threadImages;const ownerDoc=(null!==(_caseData_threadImages=caseData.threadImages)&&void 0!==_caseData_threadImages?_caseData_threadImages:[]).find(i=>{var _i_ocrInfo;return null===(_i_ocrInfo=i.ocrInfo)||void 0===_i_ocrInfo?void 0:_i_ocrInfo.contact}),ownerLink=ownerDoc?ownerDoc.threadParent?`/cases/${caseData.id}/thread/${encodeURIComponent(ownerDoc.threadParent)}`:`/uploads/${ownerDoc.url}`:null,ownerInfo=(0,caseUtils.sC)(caseData);var _caseData_sentEmails1;const ownerNotifyEmail=(null==ownerInfo?void 0:ownerInfo.email)?(null!==(_caseData_sentEmails1=caseData.sentEmails)&&void 0!==_caseData_sentEmails1?_caseData_sentEmails1:[]).find(m=>m.to===ownerInfo.email):void 0,ownerNotifyLink=ownerNotifyEmail?`/cases/${caseData.id}/thread/${encodeURIComponent(ownerNotifyEmail.sentAt)}`:null,firstEmail=null===(_caseData_sentEmails=caseData.sentEmails)||void 0===_caseData_sentEmails?void 0:_caseData_sentEmails.find(m=>!(null==ownerInfo?void 0:ownerInfo.email)||m.to!==ownerInfo.email),notifyLink=firstEmail?`/cases/${caseData.id}/thread/${encodeURIComponent(firstEmail.sentAt)}`:null,clean=t=>t.replace(/"/g,"'");var _caseData_photoTimes_caseData_photos_;const uploadedAt=null!==(_caseData_photoTimes_caseData_photos_=caseData.photoTimes[caseData.photos[0]])&&void 0!==_caseData_photoTimes_caseData_photos_?_caseData_photoTimes_caseData_photos_:null,uploadedTip=uploadedAt?`Photo taken ${new Date(uploadedAt).toLocaleString()}`:"View uploaded photo",plateTipParts=[],plateNum=(0,caseUtils.qy)(caseData),plateState=(0,caseUtils.W7)(caseData);plateNum&&plateTipParts.push(`Plate: ${plateNum}`),plateState&&plateTipParts.push(`State: ${plateState}`),platePhoto&&plateTipParts.push("View plate photo");const plateTip=plateTipParts.join(" – "),ownerContact=(0,caseUtils.g_)(caseData),ownerTip=ownerContact?`Owner info: ${ownerContact.slice(0,40)}${ownerContact.length>40?"…":""}`:"View paperwork",notifyTip=firstEmail?`Notification email to ${firstEmail.to} on ${new Date(firstEmail.sentAt).toLocaleString()}`:"View notification email",ownerNotifyTip=ownerNotifyEmail?`Notification email to ${ownerNotifyEmail.to} on ${new Date(ownerNotifyEmail.sentAt).toLocaleString()}`:"View owner notification",analysisTip=caseData.analysis&&(0,caseUtils.Pk)(caseData.analysis),links=[caseData.photos[0]?`click uploaded "/uploads/${caseData.photos[0]}" "${clean(uploadedTip)}"`:null,platePhoto?`click plate "${platePhoto}" "${clean(plateTip)}"`:null,ownerLink?`click own "${ownerLink}" "${clean(ownerTip)}"`:null,ownerNotifyLink?`click ownnotify "${ownerNotifyLink}" "${clean(ownerNotifyTip)}"`:null,notifyLink?`click notify "${notifyLink}" "${clean(notifyTip)}"`:null,analysisTip?`click analysis "/cases/${caseData.id}" "${clean(analysisTip)}"`:null].filter(Boolean).join("\n"),c=isDark?{completedFill:"#064E3B",completedStroke:"#10B981",currentFill:"#78350F",currentStroke:"#FBBF24",pendingFill:"#1F2937",pendingStroke:"#9CA3AF"}:{completedFill:"#D1FAE5",completedStroke:"#047857",currentFill:"#FEF3C7",currentStroke:"#92400E",pendingFill:"#F3F4F6",pendingStroke:"#6B7280"},textColor=isDark?"#F9FAFB":"#000000";return`graph TD\n${nodes}\n${edges}\n${links}\nclassDef completed fill:${c.completedFill},stroke:${c.completedStroke},color:${textColor};\nclassDef current fill:${c.currentFill},stroke:${c.currentStroke},color:${textColor};\nclassDef pending fill:${c.pendingFill},stroke:${c.pendingStroke},color:${textColor};\n${`linkStyle default fill:none,stroke:${c.pendingStroke},stroke-width:2px;`}\n${classAssignments}`},[status,firstPending,noviolation,steps,isDark,caseData,analysisPending,reanalysisPending,t]),containerRef=(0,react.useRef)(null);return(0,react.useEffect)(()=>{const container=containerRef.current;if(!container)return;const instances=[],apply=()=>{var _caseData_sentEmails;for(const cleanup of instances)cleanup();instances.length=0;const map={},platePhoto=(()=>{var _caseData_analysis;const plate=(0,caseUtils.qy)(caseData);if(!plate||!(null===(_caseData_analysis=caseData.analysis)||void 0===_caseData_analysis?void 0:_caseData_analysis.images))return caseData.photos[0]?`/uploads/${caseData.photos[0]}`:null;for(const[name,info]of Object.entries(caseData.analysis.images)){var _caseData_analysis1,_info_highlights,_info_paperworkInfo_vehicle,_info_paperworkInfo,_caseData_analysis_language,_info_highlights1,_info_highlights_,_ref;const hi="string"==typeof info.highlights?info.highlights:null!==(_ref=null!==(_info_highlights_=null===(_info_highlights=info.highlights)||void 0===_info_highlights?void 0:_info_highlights[null!==(_caseData_analysis_language=null===(_caseData_analysis1=caseData.analysis)||void 0===_caseData_analysis1?void 0:_caseData_analysis1.language)&&void 0!==_caseData_analysis_language?_caseData_analysis_language:"en"])&&void 0!==_info_highlights_?_info_highlights_:Object.values(null!==(_info_highlights1=info.highlights)&&void 0!==_info_highlights1?_info_highlights1:{})[0])&&void 0!==_ref?_ref:"";if((null===(_info_paperworkInfo=info.paperworkInfo)||void 0===_info_paperworkInfo||null===(_info_paperworkInfo_vehicle=_info_paperworkInfo.vehicle)||void 0===_info_paperworkInfo_vehicle?void 0:_info_paperworkInfo_vehicle.licensePlateNumber)===plate||hi.toLowerCase().includes("plate")){const file=caseData.photos.find(p=>p.split("/").pop()===name);if(file)return`/uploads/${file}`}}return caseData.photos[0]?`/uploads/${caseData.photos[0]}`:null})();var _caseData_threadImages;const ownerDoc=(null!==(_caseData_threadImages=caseData.threadImages)&&void 0!==_caseData_threadImages?_caseData_threadImages:[]).find(i=>{var _i_ocrInfo;return null===(_i_ocrInfo=i.ocrInfo)||void 0===_i_ocrInfo?void 0:_i_ocrInfo.contact}),ownerLink=ownerDoc?ownerDoc.threadParent?`/cases/${caseData.id}/thread/${encodeURIComponent(ownerDoc.threadParent)}`:`/uploads/${ownerDoc.url}`:null,ownerInfo=(0,caseUtils.sC)(caseData);var _caseData_sentEmails1;const ownerNotifyEmail=(null==ownerInfo?void 0:ownerInfo.email)?(null!==(_caseData_sentEmails1=caseData.sentEmails)&&void 0!==_caseData_sentEmails1?_caseData_sentEmails1:[]).find(m=>m.to===ownerInfo.email):void 0,ownerNotifyLink=ownerNotifyEmail?`/cases/${caseData.id}/thread/${encodeURIComponent(ownerNotifyEmail.sentAt)}`:null,firstEmail=null===(_caseData_sentEmails=caseData.sentEmails)||void 0===_caseData_sentEmails?void 0:_caseData_sentEmails.find(m=>!(null==ownerInfo?void 0:ownerInfo.email)||m.to!==ownerInfo.email),notifyLink=firstEmail?`/cases/${caseData.id}/thread/${encodeURIComponent(firstEmail.sentAt)}`:null,bestViolation=(0,caseUtils._g)(caseData);var _ownerNotifyEmail_body,_firstEmail_body;caseData.photos.length>0&&(map.uploaded={url:`/uploads/${caseData.photos[0]}`,preview:caseData.photos.slice(-UPLOADED_PREVIEW_COUNT).map(p=>`/uploads/${p}`),isImage:!0,count:caseData.photos.length}),platePhoto&&(map.plate={url:platePhoto,preview:platePhoto,isImage:!0}),ownerLink&&(map.own={url:ownerLink,preview:(null==ownerDoc?void 0:ownerDoc.url)?`/uploads/${ownerDoc.url}`:ownerLink,isImage:!0}),ownerNotifyLink&&(map.ownnotify={url:ownerNotifyLink,preview:null!==(_ownerNotifyEmail_body=null==ownerNotifyEmail?void 0:ownerNotifyEmail.body)&&void 0!==_ownerNotifyEmail_body?_ownerNotifyEmail_body:"",isImage:!1}),notifyLink&&(map.notify={url:notifyLink,preview:null!==(_firstEmail_body=null==firstEmail?void 0:firstEmail.body)&&void 0!==_firstEmail_body?_firstEmail_body:"",isImage:!1}),bestViolation&&(map.violation={url:`/uploads/${bestViolation.photo}`,preview:`/uploads/${bestViolation.photo}`,isImage:!0,caption:bestViolation.caption});const vin=(0,caseUtils.E5)(caseData);vin&&(map.vin={url:"",preview:vin,isImage:!1}),caseData.analysis&&(map.analysis={url:`/cases/${caseData.id}`,preview:(0,caseUtils.Pk)(caseData.analysis),isImage:!1});const escapeHtml=s=>s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");for(const[id,info]of Object.entries(map)){if(!info)continue;const el=container.querySelector(`[id^='flowchart-${id}-']`);if(!el)continue;const content=(()=>{if(!1!==info.isImage){if(Array.isArray(info.preview)){const imgClass=info.preview.length>1?"max-h-24 my-1":"max-h-40",imgs=info.preview.map(p=>`<img src="${p}" class="${imgClass}" alt="case preview" />`).join(""),extra=info.count&&info.count>info.preview.length?info.count-info.preview.length:0;return`<div class="flex flex-col items-center overflow-y-auto" style="max-height:60vh; max-width:80vw;">${imgs}${extra>0?`<div class="text-xs text-center mt-1">and ${extra} more photo${1===extra?"":"s"} not shown</div>`:""}</div>`}const caption=info.caption?`<div class="text-xs text-center mt-1">${escapeHtml(info.caption)}</div>`:"";return`<div class="flex flex-col items-center"><img src="${info.preview}" class="max-h-40" alt="case preview" />${caption}</div>`}return`<div class="max-w-xs whitespace-pre-wrap">${escapeHtml(info.preview)}</div>`})(),tooltip=document.createElement("div");tooltip.innerHTML=content,tooltip.className="z-tooltip rounded bg-black/80 text-white text-xs p-2 shadow",tooltip.style.position="absolute";let cleanupAuto=null;const show=()=>{document.body.appendChild(tooltip);const update=()=>{(0,floating_ui_dom.rD)(el,tooltip,{middleware:[(0,floating_ui_dom.cY)(6),(0,floating_ui_dom.UU)(),(0,floating_ui_dom.BN)({padding:5})]}).then(({x,y})=>{Object.assign(tooltip.style,{left:`${x}px`,top:`${y}px`})})};cleanupAuto=(0,floating_ui_dom.ll)(el,tooltip,update),update()},hide=()=>{null==cleanupAuto||cleanupAuto(),cleanupAuto=null,tooltip.remove()},clickHandler=()=>window.open(info.url,"_blank");el.addEventListener("mouseenter",show),el.addEventListener("mouseleave",hide),el.addEventListener("click",clickHandler),instances.push(()=>{el.removeEventListener("mouseenter",show),el.removeEventListener("mouseleave",hide),el.removeEventListener("click",clickHandler),hide()})}},observer=new MutationObserver(()=>apply());observer.observe(container,{childList:!0,subtree:!0});const timer=window.setTimeout(apply,500);return()=>{observer.disconnect(),clearTimeout(timer);for(const cleanup of instances)cleanup()}},[caseData]),(0,jsx_runtime.jsx)("div",{className:"max-w-full overflow-x-auto",ref:containerRef,children:(0,jsx_runtime.jsx)(Mermaid,{chart,config:{theme:isDark?"dark":"default",themeVariables:isDark?{primaryTextColor:"#F9FAFB",textColor:"#F9FAFB",nodeTextColor:"#F9FAFB"}:{}}},chart)})}CaseProgressGraph.__docgenInfo={description:"",methods:[],displayName:"CaseProgressGraph",props:{caseData:{required:!0,tsType:{name:"Case"},description:""}}};var DebugWrapper=__webpack_require__("./src/app/components/DebugWrapper.tsx"),useSession=__webpack_require__("./src/app/useSession.ts"),apiClient=__webpack_require__("./src/apiClient.ts"),useEventSource=__webpack_require__("./src/app/hooks/useEventSource.ts");var QueryClientProvider=__webpack_require__("./node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js"),navigation=__webpack_require__("./node_modules/@storybook/nextjs/dist/export-mocks/navigation/index.mjs"),NotificationProvider=__webpack_require__("./src/app/components/NotificationProvider.tsx"),useCase=__webpack_require__("./src/app/hooks/useCase.ts"),useQuery=__webpack_require__("./node_modules/@tanstack/react-query/build/modern/useQuery.js");const caseMembersQueryKey=id=>[`/api/cases/${id}/members`];const CaseContext=(0,react.createContext)(null);function CaseProvider({children,initialCase,caseId}){const queryClient=(0,QueryClientProvider.jE)(),{data:caseData=null}=(0,useCase.A)(caseId,initialCase),{data:members=[]}=function useCaseMembers(id){return(0,useQuery.I)({queryKey:caseMembersQueryKey(id),enabled:!!id})}(caseId),[selectedPhoto,setSelectedPhoto]=(0,react.useState)(initialCase?(0,caseUtils.wq)(initialCase):null),notify=(0,NotificationProvider.l)(),router=(0,navigation.useRouter)(),fileInputRef=(0,react.useRef)(null);var _caseData_public;const analysisActive=function useCaseAnalysisActive(caseId,isPublic){const[active,setActive]=(0,react.useState)(!1);return(0,react.useEffect)(()=>{let closed=!1;const base=isPublic?"/api/public/cases":"/api/cases";return async function fetchStatus(){try{const res=await(0,apiClient.n)(`${base}/${encodeURIComponent(caseId)}/jobs?type=analyzeCase`);if(res.ok){var _data_jobs;const data=await res.json();var _data_jobs_length;closed||setActive((null!==(_data_jobs_length=null===(_data_jobs=data.jobs)||void 0===_data_jobs?void 0:_data_jobs.length)&&void 0!==_data_jobs_length?_data_jobs_length:0)>0)}}catch(e){}}(),()=>{closed=!0}},[caseId,isPublic]),(0,useEventSource.A)(`${isPublic?"/api/public/cases":"/api/cases"}/${encodeURIComponent(caseId)}/jobs/stream?type=analyzeCase`,data=>{setActive(data.jobs.length>0)}),active}(caseId,null!==(_caseData_public=null==caseData?void 0:caseData.public)&&void 0!==_caseData_public&&_caseData_public);async function uploadFiles(files){if(!files||0===files.length)return;(await Promise.all(Array.from(files).map(file=>{const formData=new FormData;return formData.append("photo",file),formData.append("caseId",caseId),(0,apiClient.n)("/api/upload",{method:"POST",body:formData})}))).some(r=>!r.ok)?notify("Failed to upload one or more files."):(await refreshCase(),router.refresh(),fileInputRef.current&&(fileInputRef.current.value=""))}async function refreshCase(){const res=await(0,apiClient.n)(`/api/cases/${caseId}`);res.ok?queryClient.setQueryData((0,useCase.U)(caseId),await res.json()):notify("Failed to refresh case.")}async function refreshMembers(){const res=await(0,apiClient.n)(`/api/cases/${caseId}/members`);res.ok&&queryClient.setQueryData(caseMembersQueryKey(caseId),await res.json())}(0,useEventSource.A)("/api/cases/stream",data=>{data.id===caseId&&(data.deleted?queryClient.setQueryData((0,useCase.U)(caseId),null):(queryClient.setQueryData((0,useCase.U)(caseId),data),sessionStorage.removeItem(`preview-${caseId}`)))}),(0,react.useEffect)(()=>{caseData&&setSelectedPhoto(prev=>{var _caseData_threadImages;const all=new Set([...caseData.photos,...(null!==(_caseData_threadImages=caseData.threadImages)&&void 0!==_caseData_threadImages?_caseData_threadImages:[]).map(img=>img.url)]);return prev&&all.has(prev)?prev:(0,caseUtils.wq)(caseData)})},[caseData]);const value={caseId,caseData,members,selectedPhoto,setSelectedPhoto,fileInputRef,refreshCase,updateVehicle:async function updateVehicle(plateNum,plateState){(await(0,apiClient.n)(`/api/cases/${caseId}/override`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({vehicle:{licensePlateNumber:plateNum||void 0,licensePlateState:plateState||void 0}})})).ok?await refreshCase():notify("Failed to update vehicle information.")},inviteMember:async function inviteMember(userId){if(!userId)return;(await(0,apiClient.n)(`/api/cases/${caseId}/invite`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId})})).ok?await refreshMembers():notify("Failed to invite collaborator.")},uploadFiles,handleUpload:async function handleUpload(e){const files=e.target.files;files&&await uploadFiles(files)},removeMember:async function removeMember(uid){(await(0,apiClient.n)(`/api/cases/${caseId}/members/${uid}`,{method:"DELETE"})).ok?await refreshMembers():notify("Failed to remove collaborator.")},analysisActive};return(0,jsx_runtime.jsx)(CaseContext.Provider,{value,children})}function useCaseContext(){const ctx=(0,react.useContext)(CaseContext);if(!ctx)throw new Error("useCaseContext must be used within CaseProvider");return ctx}CaseProvider.__docgenInfo={description:"",methods:[],displayName:"CaseProvider",props:{children:{required:!0,tsType:{name:"ReactReactNode",raw:"React.ReactNode"},description:""},initialCase:{required:!0,tsType:{name:"union",raw:"Case | null",elements:[{name:"Case"},{name:"null"}]},description:""},caseId:{required:!0,tsType:{name:"string"},description:""}}};var EditableText=__webpack_require__("./src/app/components/EditableText.tsx"),MapPreviewStub=__webpack_require__("./.storybook/MapPreviewStub.tsx"),basePath=__webpack_require__("./src/basePath.ts"),useMutation=__webpack_require__("./node_modules/@tanstack/react-query/build/modern/useMutation.js");function useCaseActions(){const{caseId,caseData,updateVehicle,inviteMember,removeMember,uploadFiles,handleUpload,fileInputRef}=useCaseContext(),notify=(0,NotificationProvider.l)(),router=(0,navigation.useRouter)(),queryClient=(0,QueryClientProvider.jE)(),{t}=(0,es.Bd)(),[copied,setCopied]=(0,react.useState)(!1),[reanalyzingPhoto,setReanalyzingPhoto]=(0,react.useState)(null),updateVinMutation=(0,useMutation.n)({async mutationFn(value){if(!(await(0,apiClient.n)(`/api/cases/${caseId}/vin`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({vin:value||null})})).ok)throw new Error(t("failedUpdateVin"))},onSuccess(){queryClient.invalidateQueries({queryKey:(0,useCase.U)(caseId)})},onError(){notify(t("failedUpdateVin"))}}),clearVinMutation=(0,useMutation.n)({async mutationFn(){if(!(await(0,apiClient.n)(`/api/cases/${caseId}/vin`,{method:"DELETE"})).ok)throw new Error(t("failedClearVin"))},onSuccess(){queryClient.invalidateQueries({queryKey:(0,useCase.U)(caseId)})},onError(){notify(t("failedClearVin"))}}),updateNoteMutation=(0,useMutation.n)({async mutationFn(value){if(!(await(0,apiClient.n)(`/api/cases/${caseId}/note`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({note:value||null})})).ok)throw new Error(t("failedUpdateNote"))},onSuccess(){queryClient.invalidateQueries({queryKey:(0,useCase.U)(caseId)})},onError(){notify(t("failedUpdateNote"))}}),updatePhotoNoteMutation=(0,useMutation.n)({async mutationFn({photo,value}){if(!(await(0,apiClient.n)(`/api/cases/${caseId}/photo-note`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({photo,note:value||null})})).ok)throw new Error(t("failedUpdateNote"))},onSuccess(){queryClient.invalidateQueries({queryKey:(0,useCase.U)(caseId)})},onError(){notify(t("failedUpdateNote"))}}),togglePublicMutation=(0,useMutation.n)({async mutationFn(){var _caseData_public;if(!(await(0,apiClient.n)(`/api/cases/${caseId}/public`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({public:!(null!==(_caseData_public=null==caseData?void 0:caseData.public)&&void 0!==_caseData_public&&_caseData_public)})})).ok)throw new Error(t("failedUpdateVisibility"))},onSuccess(){queryClient.invalidateQueries({queryKey:(0,useCase.U)(caseId)})},onError(){notify(t("failedUpdateVisibility"))}}),toggleClosedMutation=(0,useMutation.n)({async mutationFn(){var _caseData_closed;if(!(await(0,apiClient.n)(`/api/cases/${caseId}/closed`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({closed:!(null!==(_caseData_closed=null==caseData?void 0:caseData.closed)&&void 0!==_caseData_closed&&_caseData_closed)})})).ok)throw new Error(t("failedUpdateStatus"))},onSuccess(){queryClient.invalidateQueries({queryKey:(0,useCase.U)(caseId)})},onError(){notify(t("failedUpdateStatus"))}}),toggleArchivedMutation=(0,useMutation.n)({async mutationFn(){var _caseData_archived;if(!(await(0,apiClient.n)(`/api/cases/${caseId}/archived`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({archived:!(null!==(_caseData_archived=null==caseData?void 0:caseData.archived)&&void 0!==_caseData_archived&&_caseData_archived)})})).ok)throw new Error(t("failedUpdateStatus"))},onSuccess(){queryClient.invalidateQueries({queryKey:(0,useCase.U)(caseId)})},onError(){notify(t("failedUpdateStatus"))}});const reanalyzePhotoMutation=(0,useMutation.n)({async mutationFn({photo,detailsEl}){const url=`/api/cases/${caseId}/reanalyze-photo?photo=${encodeURIComponent(photo)}`;caseData&&queryClient.setQueryData((0,useCase.U)(caseId),{...caseData,analysisStatus:"pending"}),setReanalyzingPhoto(photo);if(!(await(0,apiClient.n)(url,{method:"POST"})).ok)throw new Error(t("failedReanalyzePhoto"));detailsEl&&(detailsEl.open=!1)},onSuccess(){queryClient.invalidateQueries({queryKey:(0,useCase.U)(caseId)})},onError(){notify(t("failedReanalyzePhoto"))}}),retryAnalysisMutation=(0,useMutation.n)({async mutationFn(){caseData&&queryClient.setQueryData((0,useCase.U)(caseId),{...caseData,analysisStatus:"pending"});if(!(await(0,apiClient.n)(`/api/cases/${caseId}/reanalyze`,{method:"POST"})).ok)throw new Error(t("failedRetryAnalysis"))},onSuccess(){queryClient.invalidateQueries({queryKey:(0,useCase.U)(caseId)})},onError(){notify(t("failedRetryAnalysis"))}}),removePhotoMutation=(0,useMutation.n)({async mutationFn(photo){if(!(await(0,apiClient.n)(`/api/cases/${caseId}/photos`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({photo})})).ok)throw new Error(t("failedRemovePhoto"));const res=await(0,apiClient.n)(`/api/cases/${caseId}`);if(!res.ok)throw new Error(t("failedRefreshAfterRemove"));queryClient.setQueryData((0,useCase.U)(caseId),await res.json())},async onSuccess(){router.refresh();window.confirm(t("confirmReanalyze"))&&(await(0,apiClient.n)(`/api/cases/${caseId}/reanalyze`,{method:"POST"}),router.refresh())},onError(){notify(t("failedRemovePhoto"))}});return{copied,copyPublicUrl:async function copyPublicUrl(){const url=`${window.location.origin}${(0,basePath.h)(`/public/cases/${caseId}`)}`;await navigator.clipboard.writeText(url),setCopied(!0),setTimeout(()=>setCopied(!1),2e3)},reanalyzingPhoto,setReanalyzingPhoto,updateVin:value=>updateVinMutation.mutateAsync(value),clearVin:()=>clearVinMutation.mutateAsync(),updateNote:value=>updateNoteMutation.mutateAsync(value),updatePhotoNote:(photo,value)=>updatePhotoNoteMutation.mutateAsync({photo,value}).then(()=>{}),togglePublic:()=>togglePublicMutation.mutate(),toggleClosed:()=>toggleClosedMutation.mutate(),toggleArchived:()=>toggleArchivedMutation.mutate(),reanalyzePhoto:(photo,detailsEl)=>reanalyzePhotoMutation.mutateAsync({photo,detailsEl}).then(()=>{}),retryAnalysis:()=>retryAnalysisMutation.mutate(),removePhoto:photo=>removePhotoMutation.mutateAsync(photo),updatePlateNumber:function updatePlateNumber(value){const state=(0,caseUtils.W7)(caseData)||"";return updateVehicle(value,state)},updatePlateState:function updatePlateState(value){const plate=(0,caseUtils.qy)(caseData)||"";return updateVehicle(plate,value)},clearPlateNumber:function clearPlateNumber(){const state=(0,caseUtils.W7)(caseData)||"";return updateVehicle("",state)},clearPlateState:function clearPlateState(){const plate=(0,caseUtils.qy)(caseData)||"";return updateVehicle(plate,"")},inviteMember,removeMember,uploadFiles,handleUpload,fileInputRef}}function useCaseProgress(reanalyzingPhoto){const{caseData,analysisActive}=useCaseContext(),{t}=(0,es.Bd)(),progress="pending"===(null==caseData?void 0:caseData.analysisStatus)&&caseData.analysisProgress?caseData.analysisProgress:null,isPhotoReanalysis=Boolean(reanalyzingPhoto&&"pending"===(null==caseData?void 0:caseData.analysisStatus)),requestValue=progress?"upload"===progress.stage?progress.index>0?progress.index/progress.total*100:void 0:"stream"===progress.stage?Math.min(progress.received/progress.total*100,100):void 0:void 0;let progressDescription="";if(progress){const prefix=progress.steps?`${t("stepPrefix",{step:progress.step,steps:progress.steps})} `:"";progressDescription="upload"===progress.stage?prefix+(progress.index>0?t("uploadingProgress",{index:progress.index,total:progress.total,percent:Math.floor(progress.index/progress.total*100),count:progress.total}):t("uploadingPhotos")):"retry"===progress.stage?prefix+t("analysisRestarting",{attempt:progress.attempt}):prefix+(progress.done?t("processingResults"):t("analyzingTokens",{received:progress.received,total:progress.total}))}else progressDescription="pending"===(null==caseData?void 0:caseData.analysisStatus)?t("analyzingPhoto"):"canceled"===(null==caseData?void 0:caseData.analysisStatus)?t("analysisCanceled"):t("analysisFailed");return{progress,progressDescription,requestValue,analysisActive,isPhotoReanalysis}}var AnalysisInfo=__webpack_require__("./src/app/components/AnalysisInfo.tsx");function useCaseTranslate(caseId){const queryClient=(0,QueryClientProvider.jE)(),notify=(0,NotificationProvider.l)(),{t}=(0,es.Bd)(),mutation=(0,useMutation.n)({async mutationFn({path,lang}){if(!(await(0,apiClient.n)(`/api/cases/${caseId}/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path,lang})})).ok)throw new Error(t("failedToTranslate"))},onSuccess(){queryClient.invalidateQueries({queryKey:(0,useCase.U)(caseId)})},onError(){notify(t("failedToTranslate"))}});return(path,lang)=>mutation.mutateAsync({path,lang}).then(()=>{})}function AnalysisStatus({readOnly=!1}){var _caseData_analysisOverrides_vehicle,_caseData_analysisOverrides,_caseData_analysisOverrides_vehicle1,_caseData_analysisOverrides1;const{caseId,caseData}=useCaseContext(),{i18n}=(0,es.Bd)(),translate=useCaseTranslate(caseId),{updatePlateNumber,updatePlateState,clearPlateNumber,clearPlateState,retryAnalysis,reanalyzingPhoto}=useCaseActions(),{progress,progressDescription}=useCaseProgress(reanalyzingPhoto);if(!caseData)return null;const plateNumberOverridden=void 0!==(null===(_caseData_analysisOverrides=caseData.analysisOverrides)||void 0===_caseData_analysisOverrides||null===(_caseData_analysisOverrides_vehicle=_caseData_analysisOverrides.vehicle)||void 0===_caseData_analysisOverrides_vehicle?void 0:_caseData_analysisOverrides_vehicle.licensePlateNumber),plateStateOverridden=void 0!==(null===(_caseData_analysisOverrides1=caseData.analysisOverrides)||void 0===_caseData_analysisOverrides1||null===(_caseData_analysisOverrides_vehicle1=_caseData_analysisOverrides1.vehicle)||void 0===_caseData_analysisOverrides_vehicle1?void 0:_caseData_analysisOverrides_vehicle1.licensePlateState),bugReportUrl="https://github.com/antialias/photo-to-citation/issues/new",failureReason=caseData.analysisError?"truncated"===caseData.analysisError?"Analysis failed because the AI response was cut off.":"parse"===caseData.analysisError?"Analysis failed due to invalid JSON from the AI.":"schema"===caseData.analysisError?"Analysis failed because the AI response did not match the expected schema.":"images"===caseData.analysisError?"Analysis failed because no images were provided or some photo files were missing.":"Analysis failed because the AI response did not match the expected format.":caseData.analysisStatusCode&&caseData.analysisStatusCode>=400?"Analysis failed. Please try again later.":"Analysis failed.";let failureDetail=null,failureFix=null;switch(caseData.analysisError){case"truncated":failureDetail="The AI response ended early, which usually means the output was too long.",failureFix=(0,jsx_runtime.jsxs)("p",{className:"mt-1",children:["Click"," ",readOnly?"retry":(0,jsx_runtime.jsx)("button",{type:"button",onClick:retryAnalysis,className:"underline",children:"retry"})," ","to try again. If it keeps failing,"," ",(0,jsx_runtime.jsx)("a",{href:bugReportUrl,target:"_blank",rel:"noopener noreferrer",className:"underline",children:"file a bug report"}),"."]});break;case"parse":failureDetail="The AI returned text that could not be parsed as JSON.",failureFix=(0,jsx_runtime.jsxs)("p",{className:"mt-1",children:[readOnly?null:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Click"," ",(0,jsx_runtime.jsx)("button",{type:"button",onClick:retryAnalysis,className:"underline",children:"retry"})," ","to try again."]})," If it keeps failing, ",(0,jsx_runtime.jsx)("a",{href:bugReportUrl,target:"_blank",rel:"noopener noreferrer",className:"underline",children:"report this issue"}),"."]});break;case"schema":failureDetail="The AI's JSON did not match the expected schema.",failureFix=(0,jsx_runtime.jsxs)("p",{className:"mt-1",children:[readOnly?null:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:["Click"," ",(0,jsx_runtime.jsx)("button",{type:"button",onClick:retryAnalysis,className:"underline",children:"retry"})," ","to try again."]})," If the problem persists, ",(0,jsx_runtime.jsx)("a",{href:bugReportUrl,target:"_blank",rel:"noopener noreferrer",className:"underline",children:"file a bug report"}),"."]});break;case"images":failureDetail="One or more uploaded photos were missing.",failureFix=(0,jsx_runtime.jsxs)("p",{className:"mt-1",children:["Ensure all photos are uploaded correctly, then"," ",readOnly?"retry":(0,jsx_runtime.jsx)("button",{type:"button",onClick:retryAnalysis,className:"underline",children:"retry analysis"}),"."]});break;default:caseData.analysisStatusCode&&caseData.analysisStatusCode>=500?(failureDetail="The server encountered an error while analyzing.",failureFix=(0,jsx_runtime.jsxs)("p",{className:"mt-1",children:["Please try again later. If the problem continues,"," ",(0,jsx_runtime.jsx)("a",{href:bugReportUrl,target:"_blank",rel:"noopener noreferrer",className:"underline",children:"file a bug report"}),"."]})):caseData.analysisStatusCode&&caseData.analysisStatusCode>=400&&(failureDetail="The request to analyze the case was rejected.",failureFix=(0,jsx_runtime.jsxs)("p",{className:"mt-1",children:["Check your inputs and try again. If you believe this is a mistake,"," ",(0,jsx_runtime.jsx)("a",{href:bugReportUrl,target:"_blank",rel:"noopener noreferrer",className:"underline",children:"report this issue"}),"."]}))}return caseData.analysis?(0,jsx_runtime.jsx)(AnalysisInfo.A,{analysis:caseData.analysis,onPlateChange:readOnly?void 0:updatePlateNumber,onStateChange:readOnly?void 0:updatePlateState,onClearPlate:readOnly?void 0:plateNumberOverridden?clearPlateNumber:void 0,onClearState:readOnly?void 0:plateStateOverridden?clearPlateState:void 0,onTranslate:()=>translate("analysis.details",i18n.language)}):"canceled"===caseData.analysisStatus?(0,jsx_runtime.jsx)("p",{className:"text-sm text-red-600",children:"Analysis canceled."}):"pending"===caseData.analysisStatus&&progress?(0,jsx_runtime.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:progressDescription}):(0,jsx_runtime.jsxs)("div",{className:"text-sm text-red-600 flex flex-col gap-1",children:[(0,jsx_runtime.jsx)("p",{children:failureReason}),readOnly?null:(0,jsx_runtime.jsx)("button",{type:"button",onClick:retryAnalysis,className:"underline w-fit",children:"Retry"}),(0,jsx_runtime.jsxs)("details",{children:[(0,jsx_runtime.jsx)("summary",{className:"cursor-pointer underline",children:"More info"}),(0,jsx_runtime.jsxs)("p",{className:"mt-1",children:["Last attempt: ",new Date(caseData.updatedAt).toLocaleString()]}),failureDetail?(0,jsx_runtime.jsx)("p",{className:"mt-1",children:failureDetail}):null,caseData.analysisStatusCode?(0,jsx_runtime.jsxs)("p",{className:"mt-1",children:["Status code: ",caseData.analysisStatusCode]}):null,failureFix]})]})}function MemberList({readOnly=!1}){var _session_user,_session_user1;const{members,inviteMember,removeMember}=useCaseContext(),[inviteUserId,setInviteUserId]=(0,react.useState)(""),{data:session}=(0,useSession.wV)(),isOwner=members.some(m=>{var _session_user;return m.userId===(null==session||null===(_session_user=session.user)||void 0===_session_user?void 0:_session_user.id)&&"owner"===m.role}),canManageMembers="admin"===(null==session||null===(_session_user=session.user)||void 0===_session_user?void 0:_session_user.role)||"superadmin"===(null==session||null===(_session_user1=session.user)||void 0===_session_user1?void 0:_session_user1.role)||isOwner;return(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Members:"}),(0,jsx_runtime.jsx)("ul",{className:"ml-2 mt-1 flex flex-col gap-1",children:members.map(m=>{var _m_name,_ref;return(0,jsx_runtime.jsxs)("li",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsxs)("span",{className:"flex-1",children:[null!==(_ref=null!==(_m_name=m.name)&&void 0!==_m_name?_m_name:m.email)&&void 0!==_ref?_ref:m.userId," (",m.role,")"]}),readOnly||!canManageMembers||"owner"===m.role?null:(0,jsx_runtime.jsx)("button",{type:"button",onClick:()=>removeMember(m.userId),className:"text-red-600",children:"Remove"})]},m.userId)})}),readOnly||!canManageMembers?null:(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,jsx_runtime.jsx)("input",{type:"text",value:inviteUserId,onChange:e=>setInviteUserId(e.target.value),placeholder:"User ID",className:"border rounded p-1 flex-1 bg-white dark:bg-gray-900"}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:()=>{inviteMember(inviteUserId),setInviteUserId("")},className:"bg-blue-600 text-white px-2 py-1 rounded",children:"Invite"})]})]})}function CaseDetails({readOnly=!1}){var _session_user,_session_user1;const{caseData,members}=useCaseContext(),{updateVin,clearVin,updateNote,togglePublic,toggleClosed,toggleArchived,reanalyzingPhoto}=useCaseActions();useCaseProgress(reanalyzingPhoto);const{data:session}=(0,useSession.wV)(),{t}=(0,es.Bd)();if(!caseData)return null;const ownerContact=(0,caseUtils.g_)(caseData),isOwner=members.some(m=>{var _session_user;return m.userId===(null==session||null===(_session_user=session.user)||void 0===_session_user?void 0:_session_user.id)&&"owner"===m.role}),isAdmin="admin"===(null==session||null===(_session_user=session.user)||void 0===_session_user?void 0:_session_user.role)||"superadmin"===(null==session||null===(_session_user1=session.user)||void 0===_session_user1?void 0:_session_user1.role),canTogglePublic=(isAdmin||!!(null==session?void 0:session.user))&&!readOnly,canToggleStatus=(isAdmin||isOwner)&&!readOnly,vin=(0,caseUtils.E5)(caseData)||"",vinOverridden=null!==caseData.vinOverride,note=caseData.note||"",gps=(0,caseUtils.qR)(caseData);return(0,jsx_runtime.jsxs)("div",{className:"order-first bg-gray-100 dark:bg-gray-800 p-4 rounded flex flex-col gap-2 text-sm",children:[(0,jsx_runtime.jsx)(AnalysisStatus,{readOnly}),ownerContact?(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:t("owner")})," ",ownerContact]}):null,(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:t("created")})," ",new Date(caseData.createdAt).toLocaleString()]}),(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:t("visibility")})," ",caseData.public?t("public"):t("private"),canTogglePublic?(0,jsx_runtime.jsx)("button",{type:"button",onClick:togglePublic,className:"ml-2 text-blue-500 underline","data-testid":"toggle-public-button",children:caseData.public?t("makePrivate"):t("makePublic")}):null]}),(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:t("status")})," ",caseData.archived?t("archived"):caseData.closed?t("closed"):t("open"),canToggleStatus?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("button",{type:"button",onClick:toggleClosed,className:"ml-2 text-blue-500 underline",children:caseData.closed?t("markOpen"):t("markClosed")}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:toggleArchived,className:"ml-2 text-blue-500 underline",children:caseData.archived?t("unarchive"):t("archive")})]}):null]}),caseData.streetAddress?(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:t("address")})," ",caseData.streetAddress]}):null,caseData.intersection?(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:t("intersection")})," ",caseData.intersection]}):null,gps?(0,jsx_runtime.jsx)(MapPreviewStub.A,{lat:gps.lat,lon:gps.lon,width:600,height:300,className:"w-full aspect-[2/1] md:max-w-xl",link:`https://www.google.com/maps?q=${gps.lat},${gps.lon}`}):null,(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:t("vin")})," ",readOnly?(0,jsx_runtime.jsx)("span",{children:vin||""}):(0,jsx_runtime.jsx)(EditableText.A,{value:vin,onSubmit:updateVin,onClear:vinOverridden?clearVin:void 0,placeholder:"VIN"})]}),(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:t("note")})," ",readOnly?(0,jsx_runtime.jsx)("span",{children:note||""}):(0,jsx_runtime.jsx)(EditableText.A,{value:note,onSubmit:updateNote,onClear:note?()=>updateNote(""):void 0,placeholder:t("add")})]}),(0,jsx_runtime.jsx)(MemberList,{readOnly})]})}AnalysisStatus.__docgenInfo={description:"",methods:[],displayName:"AnalysisStatus",props:{readOnly:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}}}},MemberList.__docgenInfo={description:"",methods:[],displayName:"MemberList",props:{readOnly:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}}}},CaseDetails.__docgenInfo={description:"",methods:[],displayName:"CaseDetails",props:{readOnly:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}}}};var thumbnail_image=__webpack_require__("./src/components/thumbnail-image.tsx"),clientThumbnails=__webpack_require__("./src/lib/clientThumbnails.ts");function buildThreads(c){var _c_sentEmails;const mails=null!==(_c_sentEmails=c.sentEmails)&&void 0!==_c_sentEmails?_c_sentEmails:[],threads=new Map;for(const mail of mails){let root=mail;for(;root.replyTo;){const parent=mails.find(m=>m.sentAt===root.replyTo);if(!parent)break;root=parent}const current=threads.get(root.sentAt);(!current||new Date(mail.sentAt)>new Date(current.sentAt))&&threads.set(root.sentAt,mail)}return Array.from(threads.values()).sort((a,b)=>new Date(a.sentAt).getTime()-new Date(b.sentAt).getTime())}function baseName(filePath){const parts=filePath.split(/[\\/]/);return parts[parts.length-1]}function CaseExtraInfo({caseId}){var _caseData_analysis;const{caseData,selectedPhoto,setSelectedPhoto}=useCaseContext(),{t}=(0,es.Bd)();if(!caseData)return null;var _caseData_analysis_images;const analysisImages=null!==(_caseData_analysis_images=null===(_caseData_analysis=caseData.analysis)||void 0===_caseData_analysis?void 0:_caseData_analysis.images)&&void 0!==_caseData_analysis_images?_caseData_analysis_images:{};var _caseData_threadImages;const paperworkScans=(null!==(_caseData_threadImages=caseData.threadImages)&&void 0!==_caseData_threadImages?_caseData_threadImages:[]).map(img=>({url:img.url,time:img.uploadedAt})),allPaperwork=[...caseData.photos.filter(p=>{var _analysisImages_baseName;return null===(_analysisImages_baseName=analysisImages[baseName(p)])||void 0===_analysisImages_baseName?void 0:_analysisImages_baseName.paperwork}).map(p=>({url:p,time:caseData.photoTimes[p]})),...paperworkScans];return(0,jsx_runtime.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[caseData.sentEmails&&caseData.sentEmails.length>0?(0,jsx_runtime.jsxs)("div",{className:"bg-gray-100 dark:bg-gray-800 p-4 rounded flex flex-col gap-2",children:[(0,jsx_runtime.jsx)("h2",{className:"font-semibold",children:t("emailLog")}),(0,jsx_runtime.jsx)("ul",{className:"flex flex-col gap-2 text-sm",children:buildThreads(caseData).map(mail=>(0,jsx_runtime.jsxs)("li",{id:`email-${mail.sentAt}`,className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsxs)("span",{children:[new Date(mail.sentAt).toLocaleString()," - ",mail.subject]}),(0,jsx_runtime.jsxs)("span",{className:"text-gray-500 dark:text-gray-400",children:[t("to")," ",mail.to]}),(0,jsx_runtime.jsx)("span",{className:"text-gray-500 dark:text-gray-400 whitespace-pre-wrap",children:mail.body}),(0,jsx_runtime.jsx)("a",{href:`/cases/${caseId}/thread/${encodeURIComponent(mail.sentAt)}`,className:"self-start text-blue-500 underline",children:t("viewThread")})]},mail.sentAt))})]}):null,allPaperwork.length>0?(0,jsx_runtime.jsxs)("div",{className:"bg-gray-100 dark:bg-gray-800 p-4 rounded flex flex-col gap-2",children:[(0,jsx_runtime.jsx)("h2",{className:"font-semibold",children:t("paperwork")}),(0,jsx_runtime.jsx)("div",{className:"flex gap-2 flex-wrap",children:allPaperwork.map(({url,time})=>{var _analysisImages_baseName;const info={url,time,analysis:null!==(_analysisImages_baseName=analysisImages[baseName(url)])&&void 0!==_analysisImages_baseName?_analysisImages_baseName:null};return(0,jsx_runtime.jsx)(DebugWrapper.A,{data:info,children:(0,jsx_runtime.jsx)("div",{className:"relative",children:(0,jsx_runtime.jsxs)("button",{type:"button",onClick:()=>setSelectedPhoto(url),className:selectedPhoto===url?"ring-2 ring-blue-500":"ring-1 ring-transparent",children:[(0,jsx_runtime.jsx)("div",{className:"relative w-20 aspect-[4/3]",children:(0,jsx_runtime.jsx)(thumbnail_image.A,{src:(0,clientThumbnails.s)(url,128),alt:t("paperwork"),width:80,height:60,imgClassName:"object-contain"})}),time?(0,jsx_runtime.jsx)("span",{className:"absolute bottom-1 left-1 bg-black/60 text-white text-xs rounded px-1",children:new Date(time).toLocaleDateString()}):null]})})},url)})})]}):null]})}CaseExtraInfo.__docgenInfo={description:"",methods:[],displayName:"CaseExtraInfo",props:{caseId:{required:!0,tsType:{name:"string"},description:""}}};var useCloseOnOutsideClick=__webpack_require__("./src/app/useCloseOnOutsideClick.ts"),ui_progress=__webpack_require__("./src/components/ui/progress.tsx"),next_link=__webpack_require__("./node_modules/next/link.js"),link_default=__webpack_require__.n(next_link);function CaseToolbar({caseId,disabled=!1,hasOwner=!1,progress,canDelete=!1,closed=!1,archived=!1,violationOverride=!1,readOnly=!1}){const{t}=(0,es.Bd)(),reqText=progress?"upload"===progress.stage?progress.index>0?t("uploadingProgress",{index:progress.index,total:progress.total,percent:Math.floor(progress.index/progress.total*100),count:progress.total}):t("uploadingPhotos"):"retry"===progress.stage?t("analysisRestarting",{attempt:progress.attempt}):progress.done?t("processingResults"):t("analyzingTokens",{received:progress.received,total:progress.total}):null,progressText=progress?`${progress.steps?`Step ${progress.step} of ${progress.steps}: `:""}${reqText}`:null,requestValue=progress?"upload"===progress.stage?progress.index>0?progress.index/progress.total*100:void 0:"stream"===progress.stage?Math.min(progress.received/progress.total*100,100):void 0:void 0,overallValue=void 0!==(null==progress?void 0:progress.steps)&&void 0!==progress.step?(progress.step-1+(null!=requestValue?requestValue:0)/100)/progress.steps*100:void 0,detailsRef=(0,react.useRef)(null);return(0,useCloseOnOutsideClick.A)(detailsRef),(0,jsx_runtime.jsxs)("div",{className:"bg-gray-100 dark:bg-gray-800 px-8 py-2 flex flex-col gap-2 flex-1",children:[progress?(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,jsx_runtime.jsx)(ui_progress.k,{value:overallValue,indeterminate:void 0===overallValue}),(0,jsx_runtime.jsx)(ui_progress.k,{value:requestValue,indeterminate:void 0===requestValue}),(0,jsx_runtime.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:progressText})]}):null,readOnly?null:(0,jsx_runtime.jsx)("div",{className:"flex justify-end",children:(0,jsx_runtime.jsxs)("details",{ref:detailsRef,className:"relative",onToggle:()=>{var _detailsRef_current,_detailsRef_current_querySelector;(null===(_detailsRef_current=detailsRef.current)||void 0===_detailsRef_current?void 0:_detailsRef_current.open)&&(null===(_detailsRef_current_querySelector=detailsRef.current.querySelector("button, a"))||void 0===_detailsRef_current_querySelector||_detailsRef_current_querySelector.focus())},children:[(0,jsx_runtime.jsx)("summary",{className:"cursor-pointer select-none bg-gray-300 dark:bg-gray-700 px-2 py-1 rounded","aria-label":t("caseActionsMenu"),children:t("actions")}),(0,jsx_runtime.jsxs)("div",{className:"absolute right-0 mt-1 bg-white dark:bg-gray-900 border rounded shadow",role:"menu",children:[(0,jsx_runtime.jsx)("button",{type:"button",onClick:async()=>{await(0,apiClient.n)(`/api/cases/${caseId}/reanalyze`,{method:"POST"}),window.location.reload()},className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:t("rerunAnalysis")}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:async()=>{await(0,apiClient.n)(`/api/cases/${caseId}/archived`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({archived:!archived})}),window.location.reload()},"data-testid":"archive-case-button",className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:t(archived?"unarchiveCase":"archiveCase")}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:async()=>{if(violationOverride)await(0,apiClient.n)(`/api/cases/${caseId}/violation-override`,{method:"DELETE"}),window.location.reload();else{const reason=prompt(t("forceViolationReason"));null!==reason&&(await(0,apiClient.n)(`/api/cases/${caseId}/violation-override`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({violation:!0,reason})}),window.location.reload())}},className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:t(violationOverride?"clearViolationOverride":"forceViolation")}),disabled?null:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[progress?(0,jsx_runtime.jsx)("button",{type:"button",onClick:async()=>{await(0,apiClient.n)(`/api/cases/${caseId}/cancel-analysis`,{method:"POST"}),window.location.reload()},className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:t("cancelAnalysis")}):null,(0,jsx_runtime.jsx)(link_default(),{href:`/cases/${caseId}/compose`,className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700",children:t("draftEmail")}),hasOwner?null:(0,jsx_runtime.jsx)(link_default(),{href:`/cases/${caseId}/ownership`,className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700",children:t("requestOwnershipInfo")}),hasOwner?(0,jsx_runtime.jsx)(link_default(),{href:`/cases/${caseId}/notify-owner`,className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700",children:t("notifyRegisteredOwner")}):null,(0,jsx_runtime.jsx)("button",{type:"button",onClick:async()=>{await(0,apiClient.n)(`/api/cases/${caseId}/closed`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({closed:!closed})}),window.location.reload()},"data-testid":"close-case-button",className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:t(closed?"reopenCase":"closeCase")})]}),canDelete?(0,jsx_runtime.jsx)("button",{type:"button",onClick:async()=>{const code=Math.random().toString(36).slice(2,6);prompt(t("confirmDelete",{code}))===code&&(await(0,apiClient.n)(`/api/cases/${caseId}`,{method:"DELETE"}),window.location.href=(0,basePath.h)("/cases"))},"data-testid":"delete-case-button",className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:t("deleteCase")}):null]})]})})]})}CaseToolbar.__docgenInfo={description:"",methods:[],displayName:"CaseToolbar",props:{caseId:{required:!0,tsType:{name:"string"},description:""},disabled:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},hasOwner:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},progress:{required:!1,tsType:{name:"union",raw:"LlmProgress | null",elements:[{name:"union",raw:'| {\n    stage: "upload";\n    index: number;\n    total: number;\n    step?: number;\n    steps?: number;\n  }\n| {\n    stage: "stream";\n    received: number;\n    total: number;\n    done: boolean;\n    step?: number;\n    steps?: number;\n  }\n| {\n    stage: "retry";\n    attempt: number;\n    reason: string;\n    step?: number;\n    steps?: number;\n  }',elements:[{name:"signature",type:"object",raw:'{\n  stage: "upload";\n  index: number;\n  total: number;\n  step?: number;\n  steps?: number;\n}',signature:{properties:[{key:"stage",value:{name:"literal",value:'"upload"',required:!0}},{key:"index",value:{name:"number",required:!0}},{key:"total",value:{name:"number",required:!0}},{key:"step",value:{name:"number",required:!1}},{key:"steps",value:{name:"number",required:!1}}]}},{name:"signature",type:"object",raw:'{\n  stage: "stream";\n  received: number;\n  total: number;\n  done: boolean;\n  step?: number;\n  steps?: number;\n}',signature:{properties:[{key:"stage",value:{name:"literal",value:'"stream"',required:!0}},{key:"received",value:{name:"number",required:!0}},{key:"total",value:{name:"number",required:!0}},{key:"done",value:{name:"boolean",required:!0}},{key:"step",value:{name:"number",required:!1}},{key:"steps",value:{name:"number",required:!1}}]}},{name:"signature",type:"object",raw:'{\n  stage: "retry";\n  attempt: number;\n  reason: string;\n  step?: number;\n  steps?: number;\n}',signature:{properties:[{key:"stage",value:{name:"literal",value:'"retry"',required:!0}},{key:"attempt",value:{name:"number",required:!0}},{key:"reason",value:{name:"string",required:!0}},{key:"step",value:{name:"number",required:!1}},{key:"steps",value:{name:"number",required:!1}}]}}]},{name:"null"}]},description:""},canDelete:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},closed:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},archived:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},violationOverride:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},readOnly:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}}}};var index_esm=__webpack_require__("__barrel_optimize__?names=FaBars!=!./node_modules/react-icons/fa/index.esm.js");function CaseHeader({caseId,readOnly=!1}){var _session_user,_session_user1;const{caseData}=useCaseContext(),{copied,copyPublicUrl,reanalyzingPhoto}=useCaseActions(),{progress,isPhotoReanalysis}=useCaseProgress(reanalyzingPhoto),{data:session}=(0,useSession.wV)(),{t}=(0,es.Bd)();if(!caseData)return null;const isAdmin="admin"===(null==session||null===(_session_user=session.user)||void 0===_session_user?void 0:_session_user.role)||"superadmin"===(null==session||null===(_session_user1=session.user)||void 0===_session_user1?void 0:_session_user1.role),ownerContact=(0,caseUtils.g_)(caseData),violationIdentified="complete"===caseData.analysisStatus&&(0,caseUtils.u5)(caseData);return(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)(link_default(),{href:"/cases","aria-label":t("backToCases"),className:"md:hidden text-xl p-2 text-blue-500 hover:text-blue-700",children:(0,jsx_runtime.jsx)(index_esm.QVr,{})}),(0,jsx_runtime.jsx)("h1",{className:"text-xl font-semibold",children:t("caseLabel",{id:caseData.id})}),caseData.public?(0,jsx_runtime.jsx)("button",{type:"button",onClick:copyPublicUrl,"aria-label":t("copyPublicLink"),className:"text-blue-500 hover:text-blue-700",children:(0,jsx_runtime.jsx)(index_esm.Zzu,{})}):null,copied?(0,jsx_runtime.jsx)("span",{className:"text-sm text-green-600",children:t("copied")}):null]}),(0,jsx_runtime.jsx)(CaseToolbar,{caseId,disabled:!violationIdentified,hasOwner:Boolean(ownerContact),progress:isPhotoReanalysis?null:progress,canDelete:isAdmin,closed:caseData.closed,archived:caseData.archived,violationOverride:Boolean(caseData.violationOverride),readOnly})]})}function ClaimBanner({show,onDismiss,className}){if(!show)return null;const{t}=(0,es.Bd)();return(0,jsx_runtime.jsxs)("div",{className:`bg-yellow-100 border border-yellow-300 text-yellow-800 p-2 flex items-center justify-between ${null!=className?className:""}`,children:[(0,jsx_runtime.jsx)("span",{children:t("claimBanner.message")}),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsx)("button",{type:"button",onClick:()=>(0,useSession.Jv)(void 0,{callbackUrl:(0,basePath.h)("/claim")}),className:"underline",children:t("claimBanner.signIn")}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:onDismiss,"aria-label":t("claimBanner.dismiss"),className:"text-xl leading-none",children:"×"})]})]})}function CaseJobList({caseId,isPublic}){const[jobs,setJobs]=(0,react.useState)([]),[auditedAt,setAuditedAt]=(0,react.useState)(0),[updatedAt,setUpdatedAt]=(0,react.useState)(0),{t}=(0,es.Bd)();return(0,useEventSource.A)(`${isPublic?"/api/public/cases":"/api/cases"}/${encodeURIComponent(caseId)}/jobs/stream`,data=>{setJobs(data.jobs),setAuditedAt(data.auditedAt),setUpdatedAt(data.updatedAt)}),0===jobs.length?null:(0,jsx_runtime.jsxs)("div",{className:"bg-gray-100 dark:bg-gray-800 p-4 rounded flex flex-col gap-2 text-sm",children:[(0,jsx_runtime.jsx)("h2",{className:"font-semibold",children:t("activeJobs")}),(0,jsx_runtime.jsx)("ul",{className:"grid gap-1",children:jobs.map(j=>(0,jsx_runtime.jsxs)("li",{className:"flex justify-between",children:[(0,jsx_runtime.jsx)("span",{className:"font-mono mr-2",children:j.type}),new Date(j.startedAt).toLocaleString()]},j.id))}),(0,jsx_runtime.jsxs)("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:[t("lastAudit")," ",auditedAt?new Date(auditedAt).toLocaleString():"n/a"," | ",t("lastUpdate")," ",updatedAt?new Date(updatedAt).toLocaleString():"n/a"]})]})}CaseHeader.__docgenInfo={description:"",methods:[],displayName:"CaseHeader",props:{caseId:{required:!0,tsType:{name:"string"},description:""},readOnly:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}}}},ClaimBanner.__docgenInfo={description:"",methods:[],displayName:"ClaimBanner",props:{show:{required:!0,tsType:{name:"boolean"},description:""},onDismiss:{required:!0,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""},className:{required:!1,tsType:{name:"string"},description:""}}},CaseJobList.__docgenInfo={description:"",methods:[],displayName:"CaseJobList",props:{caseId:{required:!0,tsType:{name:"string"},description:""},isPublic:{required:!0,tsType:{name:"boolean"},description:""}}};var dist=__webpack_require__("./node_modules/@radix-ui/react-popover/dist/index.mjs");function AddImageMenu({caseId,hasCamera,fileInputRef,onChange}){const[open,setOpen]=(0,react.useState)(!1),{t}=(0,es.Bd)();return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)(dist.bL,{open,onOpenChange:setOpen,children:[(0,jsx_runtime.jsx)(dist.l9,{asChild:!0,children:(0,jsx_runtime.jsx)("button",{type:"button",className:"flex items-center justify-center border rounded w-20 aspect-[4/3] text-sm text-gray-500 dark:text-gray-400 cursor-pointer select-none",children:t("addImage")})}),(0,jsx_runtime.jsx)(dist.ZL,{children:(0,jsx_runtime.jsxs)(dist.UC,{sideOffset:4,className:"bg-white dark:bg-gray-900 border rounded shadow text-black dark:text-white",children:[(0,jsx_runtime.jsx)("button",{type:"button",onClick:()=>{var _fileInputRef_current;setOpen(!1),null===(_fileInputRef_current=fileInputRef.current)||void 0===_fileInputRef_current||_fileInputRef_current.click()},className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",children:t("uploadImage")}),hasCamera?(0,jsx_runtime.jsx)(link_default(),{href:`/point?case=${caseId}`,className:"block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left",onClick:()=>setOpen(!1),children:t("takePhoto")}):null]})})]}),(0,jsx_runtime.jsx)("input",{ref:fileInputRef,type:"file",accept:"image/*",multiple:!0,onChange,className:"hidden"})]})}function PhotoGallery({caseId,caseData,selectedPhoto,setSelectedPhoto,handleUpload,fileInputRef,hasCamera,removePhoto,readOnly,isPhotoReanalysis,reanalyzingPhoto,requestValue}){var _caseData_analysis,_caseData_analysis_images;const analysisImages=null!==(_caseData_analysis_images=null===(_caseData_analysis=caseData.analysis)||void 0===_caseData_analysis?void 0:_caseData_analysis.images)&&void 0!==_caseData_analysis_images?_caseData_analysis_images:{},evidencePhotos=caseData.photos.filter(p=>{var _analysisImages_baseName;return!(null===(_analysisImages_baseName=analysisImages[baseName(p)])||void 0===_analysisImages_baseName?void 0:_analysisImages_baseName.paperwork)});return(0,jsx_runtime.jsxs)("div",{className:"flex gap-2 flex-wrap",children:[evidencePhotos.map(p=>{var _caseData_photoGps,_caseData_photoTimes_p,_caseData_photoGps_p,_analysisImages_baseName;const info={url:p,takenAt:null!==(_caseData_photoTimes_p=caseData.photoTimes[p])&&void 0!==_caseData_photoTimes_p?_caseData_photoTimes_p:null,gps:null!==(_caseData_photoGps_p=null===(_caseData_photoGps=caseData.photoGps)||void 0===_caseData_photoGps?void 0:_caseData_photoGps[p])&&void 0!==_caseData_photoGps_p?_caseData_photoGps_p:null,analysis:null!==(_analysisImages_baseName=analysisImages[baseName(p)])&&void 0!==_analysisImages_baseName?_analysisImages_baseName:null};return(0,jsx_runtime.jsx)(DebugWrapper.A,{data:info,children:(0,jsx_runtime.jsxs)("div",{className:"relative group",children:[(0,jsx_runtime.jsxs)("button",{type:"button",onClick:()=>setSelectedPhoto(p),className:selectedPhoto===p?"ring-2 ring-blue-500":"ring-1 ring-transparent",children:[(0,jsx_runtime.jsxs)("div",{className:"relative w-20 aspect-[4/3]",children:[(0,jsx_runtime.jsx)(thumbnail_image.A,{src:(0,clientThumbnails.s)(p,128),alt:"case photo",width:80,height:60,imgClassName:"object-contain"}),isPhotoReanalysis&&reanalyzingPhoto===p?(0,jsx_runtime.jsx)("div",{className:"absolute top-0 left-0 right-0",children:(0,jsx_runtime.jsx)(ui_progress.k,{value:requestValue,indeterminate:void 0===requestValue})}):null]}),(()=>{const t=caseData.photoTimes[p];return t?(0,jsx_runtime.jsx)("span",{className:"absolute bottom-1 left-1 bg-black/60 text-white text-xs rounded px-1",children:new Date(t).toLocaleDateString()}):null})()]}),readOnly?null:(0,jsx_runtime.jsx)("button",{type:"button",onClick:()=>removePhoto(p),className:"absolute -top-1 -right-1 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity",children:"×"})]})},p)}),readOnly?null:(0,jsx_runtime.jsx)(AddImageMenu,{caseId,hasCamera,fileInputRef,onChange:handleUpload})]})}AddImageMenu.__docgenInfo={description:"",methods:[],displayName:"AddImageMenu",props:{caseId:{required:!0,tsType:{name:"string"},description:""},hasCamera:{required:!0,tsType:{name:"boolean"},description:""},fileInputRef:{required:!0,tsType:{name:"RefObject",elements:[{name:"union",raw:"HTMLInputElement | null",elements:[{name:"HTMLInputElement"},{name:"null"}]}],raw:"RefObject<HTMLInputElement | null>"},description:""},onChange:{required:!0,tsType:{name:"signature",type:"function",raw:"(e: React.ChangeEvent<HTMLInputElement>) => void",signature:{arguments:[{type:{name:"ReactChangeEvent",raw:"React.ChangeEvent<HTMLInputElement>",elements:[{name:"HTMLInputElement"}]},name:"e"}],return:{name:"void"}}},description:""}}},PhotoGallery.__docgenInfo={description:"",methods:[],displayName:"PhotoGallery",props:{caseId:{required:!0,tsType:{name:"string"},description:""},caseData:{required:!0,tsType:{name:"Case"},description:""},selectedPhoto:{required:!0,tsType:{name:"union",raw:"string | null",elements:[{name:"string"},{name:"null"}]},description:""},setSelectedPhoto:{required:!0,tsType:{name:"signature",type:"function",raw:"(photo: string) => void",signature:{arguments:[{type:{name:"string"},name:"photo"}],return:{name:"void"}}},description:""},handleUpload:{required:!0,tsType:{name:"signature",type:"function",raw:"(e: React.ChangeEvent<HTMLInputElement>) => Promise<void>",signature:{arguments:[{type:{name:"ReactChangeEvent",raw:"React.ChangeEvent<HTMLInputElement>",elements:[{name:"HTMLInputElement"}]},name:"e"}],return:{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"}}},description:""},fileInputRef:{required:!0,tsType:{name:"ReactRefObject",raw:"React.RefObject<HTMLInputElement | null>",elements:[{name:"union",raw:"HTMLInputElement | null",elements:[{name:"HTMLInputElement"},{name:"null"}]}]},description:""},hasCamera:{required:!0,tsType:{name:"boolean"},description:""},removePhoto:{required:!0,tsType:{name:"signature",type:"function",raw:"(photo: string) => Promise<void>",signature:{arguments:[{type:{name:"string"},name:"photo"}],return:{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"}}},description:""},readOnly:{required:!0,tsType:{name:"boolean"},description:""},isPhotoReanalysis:{required:!0,tsType:{name:"boolean"},description:""},reanalyzingPhoto:{required:!0,tsType:{name:"union",raw:"string | null",elements:[{name:"string"},{name:"null"}]},description:""},requestValue:{required:!0,tsType:{name:"union",raw:"number | undefined",elements:[{name:"number"},{name:"undefined"}]},description:""}}};var PhotoViewer=__webpack_require__("./src/app/cases/[id]/components/PhotoViewer.tsx");function PhotoSection({caseId,readOnly=!1}){var _caseData_photoNotes;const{caseData,selectedPhoto,setSelectedPhoto,fileInputRef}=useCaseContext(),{handleUpload,removePhoto,reanalyzePhoto,reanalyzingPhoto,updatePhotoNote}=useCaseActions(),{progress,progressDescription,requestValue,analysisActive,isPhotoReanalysis}=useCaseProgress(reanalyzingPhoto),{i18n}=(0,es.Bd)(),translate=useCaseTranslate(caseId),[hasCamera,setHasCamera]=(0,react.useState)(!1);if((0,react.useEffect)(()=>{!("mediaDevices"in navigator)||"function"!=typeof navigator.mediaDevices.getUserMedia||"https:"!==location.protocol&&"localhost"!==location.hostname||setHasCamera(!0)},[]),!caseData)return null;const photoNote=selectedPhoto&&(null===(_caseData_photoNotes=caseData.photoNotes)||void 0===_caseData_photoNotes?void 0:_caseData_photoNotes[selectedPhoto])||"";return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(CaseJobList,{caseId,isPublic:caseData.public}),selectedPhoto?(0,jsx_runtime.jsx)(PhotoViewer.A,{caseData,selectedPhoto,progress,progressDescription,requestValue,isPhotoReanalysis,reanalyzingPhoto,analysisActive,readOnly,photoNote,updatePhotoNote:v=>updatePhotoNote(selectedPhoto,v),removePhoto,reanalyzePhoto,onTranslate:path=>translate(path,i18n.language)}):null,(0,jsx_runtime.jsx)(PhotoGallery,{caseId,caseData,selectedPhoto,setSelectedPhoto,handleUpload,fileInputRef,hasCamera,removePhoto,readOnly,isPhotoReanalysis,reanalyzingPhoto,requestValue})]})}function PublicViewBanner({caseId,show=!0,className}){const{members}=useCaseContext(),{data:session}=(0,useSession.wV)(),{t}=(0,es.Bd)(),isMember=members.some(m=>{var _session_user;return m.userId===(null==session||null===(_session_user=session.user)||void 0===_session_user?void 0:_session_user.id)});return show&&isMember?(0,jsx_runtime.jsxs)("div",{className:`bg-blue-100 border border-blue-300 text-blue-800 p-2 flex items-center justify-between ${null!=className?className:""}`,children:[(0,jsx_runtime.jsx)("span",{children:t("publicViewBanner.message")}),(0,jsx_runtime.jsx)(link_default(),{href:`/cases/${caseId}`,className:"underline",children:t("publicViewBanner.link")})]}):null}function ClientCasePage({caseId,readOnly=!1}){const{caseData,uploadFiles}=useCaseContext(),{data:session}=(0,useSession.wV)(),{t}=(0,es.Bd)(),[dragging,setDragging]=(0,react.useState)(!1),[hideClaimBanner,setHideClaimBanner]=(0,react.useState)(!1),[chatExpanded,setChatExpanded]=(0,react.useState)(!1),[preview,setPreview]=(0,react.useState)(null);(0,useDragReset.A)(()=>setDragging(!1)),(0,react.useEffect)(()=>{const stored=sessionStorage.getItem(`preview-${caseId}`);stored&&setPreview(stored)},[caseId]);const showClaimBanner=Boolean((null==caseData?void 0:caseData.sessionId)&&!(null==session?void 0:session.user)&&!hideClaimBanner);return caseData?(0,jsx_runtime.jsxs)("div",{className:"relative h-full "+(chatExpanded?"md:grid md:grid-cols-2 gap-4 overflow-hidden":""),onDragOver:readOnly?void 0:e=>e.preventDefault(),onDragEnter:readOnly?void 0:e=>{e.preventDefault(),setDragging(!0)},onDragLeave:readOnly?void 0:e=>{e.currentTarget.contains(e.relatedTarget)||setDragging(!1)},onDrop:readOnly?void 0:async e=>{e.preventDefault(),await uploadFiles(e.dataTransfer.files),setDragging(!1)},children:[(0,jsx_runtime.jsx)(ClaimBanner,{show:showClaimBanner,onDismiss:()=>setHideClaimBanner(!0),className:chatExpanded?"md:col-span-2":void 0}),(0,jsx_runtime.jsx)(PublicViewBanner,{caseId,show:readOnly,className:chatExpanded?"md:col-span-2":void 0}),(0,jsx_runtime.jsx)("div",{className:chatExpanded?"md:col-span-1 h-full overflow-y-auto":void 0,children:(0,jsx_runtime.jsx)(CaseLayout,{header:(0,jsx_runtime.jsx)(CaseHeader,{caseId,readOnly}),left:(0,jsx_runtime.jsx)(CaseProgressGraph,{caseData}),right:(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(DebugWrapper.A,{data:caseData,children:(0,jsx_runtime.jsx)(CaseDetails,{readOnly})}),(0,jsx_runtime.jsx)(PhotoSection,{caseId,readOnly})]}),children:(0,jsx_runtime.jsx)(CaseExtraInfo,{caseId})})}),readOnly||!dragging?null:(0,jsx_runtime.jsx)("div",{className:"absolute inset-0 bg-black/50 text-white flex items-center justify-center pointer-events-none text-xl z-nav",children:t("dropToAddPhotos")}),readOnly?null:(0,jsx_runtime.jsx)("div",{className:chatExpanded?"md:col-span-1 h-full overflow-y-auto":void 0,children:(0,jsx_runtime.jsx)(CaseChat.A,{caseId,expanded:chatExpanded,onExpandChange:setChatExpanded})})]}):(0,jsx_runtime.jsxs)("div",{className:"p-8 flex flex-col gap-4",children:[(0,jsx_runtime.jsx)("h1",{className:"text-xl font-semibold",children:t("uploading")}),preview?(0,jsx_runtime.jsx)("img",{src:preview,alt:"preview",className:"max-w-full",loading:"lazy"}):null,(0,jsx_runtime.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:t("uploadingPhoto")})]})}function ClientCasePageWithProvider(props){return(0,jsx_runtime.jsx)(CaseProvider,{caseId:props.caseId,initialCase:props.initialCase,children:(0,jsx_runtime.jsx)(ClientCasePage,{caseId:props.caseId,readOnly:props.readOnly})})}PhotoSection.__docgenInfo={description:"",methods:[],displayName:"PhotoSection",props:{caseId:{required:!0,tsType:{name:"string"},description:""},readOnly:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}}}},PublicViewBanner.__docgenInfo={description:"",methods:[],displayName:"PublicViewBanner",props:{caseId:{required:!0,tsType:{name:"string"},description:""},show:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},className:{required:!1,tsType:{name:"string"},description:""}}},ClientCasePageWithProvider.__docgenInfo={description:"",methods:[],displayName:"ClientCasePageWithProvider",props:{initialCase:{required:!0,tsType:{name:"union",raw:"Case | null",elements:[{name:"Case"},{name:"null"}]},description:""},caseId:{required:!0,tsType:{name:"string"},description:""},readOnly:{required:!1,tsType:{name:"boolean"},description:""}}}},"./src/app/cases/useDragReset.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>useDragReset});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/next/dist/compiled/react/index.js");function useDragReset(reset){(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)(()=>{function handleDragEnd(){reset()}function handleDragLeave(e){e.relatedTarget||reset()}return window.addEventListener("dragend",handleDragEnd),window.addEventListener("drop",handleDragEnd),window.addEventListener("dragleave",handleDragLeave),()=>{window.removeEventListener("dragend",handleDragEnd),window.removeEventListener("drop",handleDragEnd),window.removeEventListener("dragleave",handleDragLeave)}},[reset])}},"./src/app/components/AnalysisInfo.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>AnalysisInfo});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),localizedText=__webpack_require__("./src/lib/localizedText.ts");const US_STATES=["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"];var es=__webpack_require__("./node_modules/react-i18next/dist/es/index.js"),EditableText=__webpack_require__("./src/app/components/EditableText.tsx"),InlineTranslateButton=__webpack_require__("./src/app/components/InlineTranslateButton.tsx");function AnalysisInfo({analysis,onPlateChange,onStateChange,onClearPlate,onClearState,onTranslate}){const{i18n,t}=(0,es.Bd)(),{violationType,details,location,vehicle={}}=analysis,{text:detailText,needsTranslation}=(0,localizedText.P)(details,i18n.language);var _vehicle_licensePlateState,_vehicle_licensePlateNumber;return(0,jsx_runtime.jsxs)("div",{className:"flex flex-col gap-1 text-sm",children:[(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Violation:"})," ",violationType]}),(0,jsx_runtime.jsxs)("p",{children:[detailText,needsTranslation?(0,jsx_runtime.jsx)(InlineTranslateButton.A,{lang:i18n.language,onTranslate:()=>null==onTranslate?void 0:onTranslate("analysis.details",i18n.language)}):null]}),location?(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("span",{className:"font-semibold",children:"Location clues:"})," ",location]}):null,(0,jsx_runtime.jsxs)("div",{className:"pl-4 flex flex-col gap-1",children:[vehicle.make?(0,jsx_runtime.jsxs)("span",{children:["Make: ",vehicle.make]}):null,vehicle.model?(0,jsx_runtime.jsxs)("span",{children:["Model: ",vehicle.model]}):null,vehicle.type?(0,jsx_runtime.jsxs)("span",{children:["Type: ",vehicle.type]}):null,vehicle.color?(0,jsx_runtime.jsxs)("span",{children:["Color: ",vehicle.color]}):null,onPlateChange||onStateChange?(0,jsx_runtime.jsxs)("span",{className:"inline-flex items-center gap-1",children:["Plate:",onStateChange?(0,jsx_runtime.jsx)(EditableText.A,{value:null!==(_vehicle_licensePlateState=vehicle.licensePlateState)&&void 0!==_vehicle_licensePlateState?_vehicle_licensePlateState:"",onSubmit:onStateChange,onClear:onClearState,placeholder:"state",options:US_STATES}):vehicle.licensePlateState?(0,jsx_runtime.jsx)("span",{children:vehicle.licensePlateState}):null,onPlateChange?(0,jsx_runtime.jsx)(EditableText.A,{value:null!==(_vehicle_licensePlateNumber=vehicle.licensePlateNumber)&&void 0!==_vehicle_licensePlateNumber?_vehicle_licensePlateNumber:"",onSubmit:onPlateChange,onClear:onClearPlate,placeholder:"plate"}):vehicle.licensePlateNumber?(0,jsx_runtime.jsx)("span",{children:vehicle.licensePlateNumber}):null]}):vehicle.licensePlateState||vehicle.licensePlateNumber?(0,jsx_runtime.jsxs)("span",{children:["Plate:"," ",vehicle.licensePlateState?`${vehicle.licensePlateState} `:"",vehicle.licensePlateNumber]}):null]})]})}AnalysisInfo.__docgenInfo={description:"",methods:[],displayName:"AnalysisInfo",props:{analysis:{required:!0,tsType:{name:"ViolationReport"},description:""},onPlateChange:{required:!1,tsType:{name:"signature",type:"function",raw:"(v: string) => Promise<void> | void",signature:{arguments:[{type:{name:"string"},name:"v"}],return:{name:"union",raw:"Promise<void> | void",elements:[{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"},{name:"void"}]}}},description:""},onStateChange:{required:!1,tsType:{name:"signature",type:"function",raw:"(v: string) => Promise<void> | void",signature:{arguments:[{type:{name:"string"},name:"v"}],return:{name:"union",raw:"Promise<void> | void",elements:[{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"},{name:"void"}]}}},description:""},onClearPlate:{required:!1,tsType:{name:"signature",type:"function",raw:"() => Promise<void> | void",signature:{arguments:[],return:{name:"union",raw:"Promise<void> | void",elements:[{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"},{name:"void"}]}}},description:""},onClearState:{required:!1,tsType:{name:"signature",type:"function",raw:"() => Promise<void> | void",signature:{arguments:[],return:{name:"union",raw:"Promise<void> | void",elements:[{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"},{name:"void"}]}}},description:""},onTranslate:{required:!1,tsType:{name:"signature",type:"function",raw:"(path: string, lang: string) => Promise<void> | void",signature:{arguments:[{type:{name:"string"},name:"path"},{type:{name:"string"},name:"lang"}],return:{name:"union",raw:"Promise<void> | void",elements:[{name:"Promise",elements:[{name:"void"}],raw:"Promise<void>"},{name:"void"}]}}},description:""}}}},"./src/app/hooks/useCase.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>useCase,U:()=>caseQueryKey});var _tanstack_react_query__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@tanstack/react-query/build/modern/useQuery.js");const caseQueryKey=id=>[`/api/cases/${id}`];function useCase(id,initialData){return(0,_tanstack_react_query__WEBPACK_IMPORTED_MODULE_0__.I)({queryKey:caseQueryKey(id),initialData:null!=initialData?initialData:void 0,enabled:!!id})}},"./src/app/hooks/useEventSource.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>useEventSource});var _apiClient__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/apiClient.ts"),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/next/dist/compiled/react/index.js");function useEventSource(url,onData){const handleMessage=(0,react__WEBPACK_IMPORTED_MODULE_1__.useCallback)(e=>{try{onData(JSON.parse(e.data))}catch(e){}},[onData]);(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{if(!url)return;const es=(0,_apiClient__WEBPACK_IMPORTED_MODULE_0__.a)(url);return es.onmessage=handleMessage,()=>es.close()},[url,handleMessage])}},"./src/app/useSession.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{CI:()=>next_auth_react__WEBPACK_IMPORTED_MODULE_0__.signOut,Jv:()=>next_auth_react__WEBPACK_IMPORTED_MODULE_0__.signIn,wV:()=>next_auth_react__WEBPACK_IMPORTED_MODULE_0__.useSession});var next_auth_react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/next-auth/react/index.js")}}]);