"use strict";(self.webpackChunkapp_scaffold=self.webpackChunkapp_scaffold||[]).push([[2461],{"./node_modules/.pnpm/@tanstack+react-query@5.81.5_react@19.1.0/node_modules/@tanstack/react-query/build/modern/useMutation.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{n:()=>useMutation});var react=__webpack_require__("./node_modules/.pnpm/next@15.3.3_@babel+core@7.7.4_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/react/index.js"),mutation=__webpack_require__("./node_modules/.pnpm/@tanstack+query-core@5.81.5/node_modules/@tanstack/query-core/build/modern/mutation.js"),notifyManager=__webpack_require__("./node_modules/.pnpm/@tanstack+query-core@5.81.5/node_modules/@tanstack/query-core/build/modern/notifyManager.js"),subscribable=__webpack_require__("./node_modules/.pnpm/@tanstack+query-core@5.81.5/node_modules/@tanstack/query-core/build/modern/subscribable.js"),utils=__webpack_require__("./node_modules/.pnpm/@tanstack+query-core@5.81.5/node_modules/@tanstack/query-core/build/modern/utils.js"),MutationObserver=class extends subscribable.Q{#client;#currentResult=void 0;#currentMutation;#mutateOptions;constructor(client,options){super(),this.#client=client,this.setOptions(options),this.bindMethods(),this.#updateResult()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(options){const prevOptions=this.options;this.options=this.#client.defaultMutationOptions(options),(0,utils.f8)(this.options,prevOptions)||this.#client.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#currentMutation,observer:this}),prevOptions?.mutationKey&&this.options.mutationKey&&(0,utils.EN)(prevOptions.mutationKey)!==(0,utils.EN)(this.options.mutationKey)?this.reset():"pending"===this.#currentMutation?.state.status&&this.#currentMutation.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#currentMutation?.removeObserver(this)}onMutationUpdate(action){this.#updateResult(),this.#notify(action)}getCurrentResult(){return this.#currentResult}reset(){this.#currentMutation?.removeObserver(this),this.#currentMutation=void 0,this.#updateResult(),this.#notify()}mutate(variables,options){return this.#mutateOptions=options,this.#currentMutation?.removeObserver(this),this.#currentMutation=this.#client.getMutationCache().build(this.#client,this.options),this.#currentMutation.addObserver(this),this.#currentMutation.execute(variables)}#updateResult(){const state=this.#currentMutation?.state??(0,mutation.$)();this.#currentResult={...state,isPending:"pending"===state.status,isSuccess:"success"===state.status,isError:"error"===state.status,isIdle:"idle"===state.status,mutate:this.mutate,reset:this.reset}}#notify(action){notifyManager.jG.batch(()=>{if(this.#mutateOptions&&this.hasListeners()){const variables=this.#currentResult.variables,context=this.#currentResult.context;"success"===action?.type?(this.#mutateOptions.onSuccess?.(action.data,variables,context),this.#mutateOptions.onSettled?.(action.data,null,variables,context)):"error"===action?.type&&(this.#mutateOptions.onError?.(action.error,variables,context),this.#mutateOptions.onSettled?.(void 0,action.error,variables,context))}this.listeners.forEach(listener=>{listener(this.#currentResult)})})}},QueryClientProvider=__webpack_require__("./node_modules/.pnpm/@tanstack+react-query@5.81.5_react@19.1.0/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js");function useMutation(options,queryClient){const client=(0,QueryClientProvider.jE)(queryClient),[observer]=react.useState(()=>new MutationObserver(client,options));react.useEffect(()=>{observer.setOptions(options)},[observer,options]);const result=react.useSyncExternalStore(react.useCallback(onStoreChange=>observer.subscribe(notifyManager.jG.batchCalls(onStoreChange)),[observer]),()=>observer.getCurrentResult(),()=>observer.getCurrentResult()),mutate=react.useCallback((variables,mutateOptions)=>{observer.mutate(variables,mutateOptions).catch(utils.lQ)},[observer]);if(result.error&&(0,utils.GU)(observer.options.throwOnError,[result.error]))throw result.error;return{...result,mutate,mutateAsync:result.mutate}}},"./src/app/components/NotificationProvider.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{l:()=>useNotify});__webpack_require__("./node_modules/.pnpm/next@15.3.3_@babel+core@7.7.4_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/react/jsx-runtime.js");var react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/next@15.3.3_@babel+core@7.7.4_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/react/index.js");__webpack_require__("./node_modules/.pnpm/react-hot-toast@2.5.2_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/react-hot-toast/dist/index.mjs");const NotifyContext=(0,react__WEBPACK_IMPORTED_MODULE_1__.createContext)(()=>{});function useNotify(){return(0,react__WEBPACK_IMPORTED_MODULE_1__.useContext)(NotifyContext)}},"./src/app/point/PointAndShootPage.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Default:()=>Default,__namedExportsOrder:()=>__namedExportsOrder,default:()=>PointAndShootPage_stories});var jsx_runtime=__webpack_require__("./node_modules/.pnpm/next@15.3.3_@babel+core@7.7.4_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/react/jsx-runtime.js"),next_link=__webpack_require__("./node_modules/.pnpm/next@15.3.3_@babel+core@7.7.4_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/link.js"),link_default=__webpack_require__.n(next_link),navigation=__webpack_require__("./node_modules/.pnpm/@storybook+nextjs@8.6.14_esbuild@0.25.5_next@15.3.3_@babel+core@7.7.4_react-dom@19.1.0_react@_htn273eqkwxmbpgcwhwcuzbpny/node_modules/@storybook/nextjs/dist/export-mocks/navigation/index.mjs"),react=__webpack_require__("./node_modules/.pnpm/next@15.3.3_@babel+core@7.7.4_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/react/index.js"),es=__webpack_require__("./node_modules/.pnpm/react-i18next@15.6.0_i18next@25.3.1_typescript@5.8.3__react-dom@19.1.0_react@19.1.0__react@19.1.0_typescript@5.8.3/node_modules/react-i18next/dist/es/index.js"),useAddFilesToCase=__webpack_require__("./src/app/useAddFilesToCase.ts"),useNewCaseFromFiles=__webpack_require__("./src/app/useNewCaseFromFiles.ts"),console=__webpack_require__("./node_modules/.pnpm/console-browserify@1.2.0/node_modules/console-browserify/index.js");function PointAndShootPage(){const videoRef=(0,react.useRef)(null),canvasRef=(0,react.useRef)(null),inputRef=(0,react.useRef)(null),workerRef=(0,react.useRef)(null),[analysisHint,setAnalysisHint]=(0,react.useState)(null),[cameraError,setCameraError]=(0,react.useState)(null),[uploading,setUploading]=(0,react.useState)(!1),[gps,setGps]=(0,react.useState)(null),{t}=(0,es.Bd)(),caseId=(0,navigation.useSearchParams)().get("case")||null,addFiles=(0,useAddFilesToCase.A)(null!=caseId?caseId:""),newCase=(0,useNewCaseFromFiles.A)(),uploadCase=caseId?addFiles:newCase;return(0,react.useEffect)(()=>{navigator.geolocation&&navigator.geolocation.getCurrentPosition(pos=>{setGps({lat:pos.coords.latitude,lon:pos.coords.longitude})})},[]),(0,react.useEffect)(()=>{!async function startCamera(){var _navigator_mediaDevices;if(null===(_navigator_mediaDevices=navigator.mediaDevices)||void 0===_navigator_mediaDevices?void 0:_navigator_mediaDevices.getUserMedia)if("https:"===location.protocol||"localhost"===location.hostname)try{const constraints={audio:!1,video:{facingMode:"environment"}},stream=await navigator.mediaDevices.getUserMedia(constraints),v=videoRef.current;v&&(v.setAttribute("autoplay",""),v.setAttribute("muted",""),v.setAttribute("playsinline",""),"srcObject"in v?v.srcObject=stream:v.src=URL.createObjectURL(stream),v.onloadedmetadata=()=>{v.play().catch(()=>{})})}catch(err){console.error("Could not access camera",err),setCameraError(t("cameraAccessError"))}else setCameraError(t("cameraRequiresSecure"));else setCameraError(t("cameraApiUnavailable"))}();const w="undefined"==typeof Worker?null:new Worker(new URL(__webpack_require__.p+__webpack_require__.u(3587),__webpack_require__.b),{type:void 0});w&&(workerRef.current=w,w.postMessage({type:"load",modelUrl:"/models/demo.onnx"}),w.onmessage=e=>{if("result"===e.data.type){var _r_vehicle;const r=e.data.result;var _r_vehicle_licensePlateNumber,_ref;setAnalysisHint(null!==(_ref=null!==(_r_vehicle_licensePlateNumber=null===(_r_vehicle=r.vehicle)||void 0===_r_vehicle?void 0:_r_vehicle.licensePlateNumber)&&void 0!==_r_vehicle_licensePlateNumber?_r_vehicle_licensePlateNumber:r.violationType)&&void 0!==_ref?_ref:null)}});let handle=0;handle=window.setInterval(()=>{const video=videoRef.current,canvas=canvasRef.current;if(!video||!canvas||!w)return;const ctx=canvas.getContext("2d");if(!ctx)return;if(canvas.width=video.videoWidth,canvas.height=video.videoHeight,0===canvas.width||0===canvas.height)return;ctx.drawImage(video,0,0,canvas.width,canvas.height);const data=ctx.getImageData(0,0,canvas.width,canvas.height);w.postMessage({type:"analyze",image:data},[data.data.buffer])},2e3);const v=videoRef.current;return()=>{if(null==v?void 0:v.srcObject)for(const t of v.srcObject.getTracks())t.stop();w&&w.terminate(),clearInterval(handle)}},[t]),(0,jsx_runtime.jsxs)("div",{className:"relative h-[100dvh] overflow-hidden bg-black",children:[cameraError&&(0,jsx_runtime.jsx)("div",{className:"absolute inset-x-0 top-0 z-nav bg-red-600 text-white text-center py-2",children:cameraError}),(0,jsx_runtime.jsx)("video",{ref:videoRef,autoPlay:!0,muted:!0,playsInline:!0,className:"absolute inset-0 w-full h-full object-cover z-0",children:(0,jsx_runtime.jsx)("track",{kind:"captions",label:""})}),(0,jsx_runtime.jsx)("canvas",{ref:canvasRef,className:"hidden"}),uploading?(0,jsx_runtime.jsx)("div",{className:"absolute inset-0 bg-black/50 text-white flex items-center justify-center pointer-events-none text-xl z-nav",children:t("uploadingPhoto")}):null,(0,jsx_runtime.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none z-nav",children:(0,jsx_runtime.jsx)("div",{className:"bg-black/40 text-white px-2 py-1 rounded text-xl","data-testid":"hint",children:null!=analysisHint?analysisHint:t("nothingDetected")})}),(0,jsx_runtime.jsxs)("div",{className:"absolute inset-0 flex flex-col items-center justify-end gap-2 p-4 pointer-events-none",children:[(0,jsx_runtime.jsx)("input",{ref:inputRef,type:"file",accept:"image/*",multiple:!0,hidden:!0,onChange:e=>async function handleInputChange(files){setUploading(!0),await uploadCase(files)}(e.target.files)}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:()=>{var _inputRef_current;return null===(_inputRef_current=inputRef.current)||void 0===_inputRef_current?void 0:_inputRef_current.click()},disabled:uploading,className:"pointer-events-auto bg-white/80 text-black px-4 py-2 rounded disabled:opacity-50",children:t("uploadPicture")}),(0,jsx_runtime.jsx)("button",{type:"button",onClick:async function takePicture(){if(!videoRef.current||!canvasRef.current)return;setUploading(!0);const video=videoRef.current,canvas=canvasRef.current;canvas.width=video.videoWidth,canvas.height=video.videoHeight;const ctx=canvas.getContext("2d");ctx&&(ctx.drawImage(video,0,0,canvas.width,canvas.height),canvas.toBlob(async blob=>{if(!blob)return;const file=new File([blob],"photo.jpg",{type:"image/jpeg"}),dt=new DataTransfer;dt.items.add(file),await uploadCase(dt.files,gps)},"image/jpeg"))},disabled:uploading,className:"pointer-events-auto bg-blue-600 text-white px-4 py-2 rounded w-full disabled:opacity-50",children:t("takePicture")}),(0,jsx_runtime.jsx)(link_default(),{href:caseId?`/cases/${caseId}`:"/cases",className:"pointer-events-auto text-xs text-white underline mt-2",children:t(caseId?"backToCase":"nav.cases")})]})]})}PointAndShootPage.__docgenInfo={description:"",methods:[],displayName:"PointAndShootPage"};const PointAndShootPage_stories={component:PointAndShootPage,title:"Pages/PointAndShootPage"},Default={render:()=>(0,jsx_runtime.jsx)(PointAndShootPage,{})},__namedExportsOrder=["Default"];Default.parameters={...Default.parameters,docs:{...Default.parameters?.docs,source:{originalSource:"{\n  render: () => <PointAndShootPage />\n}",...Default.parameters?.docs?.source}}}},"./src/app/useAddFilesToCase.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>useAddFilesToCase});var _apiClient__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/apiClient.ts"),_tanstack_react_query__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/.pnpm/@tanstack+react-query@5.81.5_react@19.1.0/node_modules/@tanstack/react-query/build/modern/useMutation.js"),next_navigation__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/@storybook+nextjs@8.6.14_esbuild@0.25.5_next@15.3.3_@babel+core@7.7.4_react-dom@19.1.0_react@_htn273eqkwxmbpgcwhwcuzbpny/node_modules/@storybook/nextjs/dist/export-mocks/navigation/index.mjs"),react_i18next__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/react-i18next@15.6.0_i18next@25.3.1_typescript@5.8.3__react-dom@19.1.0_react@19.1.0__react@19.1.0_typescript@5.8.3/node_modules/react-i18next/dist/es/index.js"),_components_NotificationProvider__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/app/components/NotificationProvider.tsx");function useAddFilesToCase(caseId){const router=(0,next_navigation__WEBPACK_IMPORTED_MODULE_1__.useRouter)(),notify=(0,_components_NotificationProvider__WEBPACK_IMPORTED_MODULE_3__.l)(),{t}=(0,react_i18next__WEBPACK_IMPORTED_MODULE_2__.Bd)(),uploadMutation=(0,_tanstack_react_query__WEBPACK_IMPORTED_MODULE_4__.n)({mutationFn:async formData=>(0,_apiClient__WEBPACK_IMPORTED_MODULE_0__.n)("/api/upload",{method:"POST",body:formData})});return async(files,gps)=>{if(!files||0===files.length)return;(await Promise.all(Array.from(files).map(file=>{const formData=new FormData;return formData.append("photo",file),formData.append("caseId",caseId),gps&&(formData.append("lat",String(gps.lat)),formData.append("lon",String(gps.lon))),uploadMutation.mutateAsync(formData)}))).some(r=>!r.ok)?notify(t("failedUpload")):router.push(`/cases/${caseId}`)}}},"./src/app/useNewCaseFromFiles.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>useNewCaseFromFiles});var _apiClient__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/apiClient.ts"),_tanstack_react_query__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/.pnpm/@tanstack+react-query@5.81.5_react@19.1.0/node_modules/@tanstack/react-query/build/modern/useMutation.js"),next_navigation__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/.pnpm/@storybook+nextjs@8.6.14_esbuild@0.25.5_next@15.3.3_@babel+core@7.7.4_react-dom@19.1.0_react@_htn273eqkwxmbpgcwhwcuzbpny/node_modules/@storybook/nextjs/dist/export-mocks/navigation/index.mjs"),react_i18next__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/.pnpm/react-i18next@15.6.0_i18next@25.3.1_typescript@5.8.3__react-dom@19.1.0_react@19.1.0__react@19.1.0_typescript@5.8.3/node_modules/react-i18next/dist/es/index.js"),_components_NotificationProvider__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/app/components/NotificationProvider.tsx");function useNewCaseFromFiles(){const router=(0,next_navigation__WEBPACK_IMPORTED_MODULE_1__.useRouter)(),notify=(0,_components_NotificationProvider__WEBPACK_IMPORTED_MODULE_3__.l)(),{t}=(0,react_i18next__WEBPACK_IMPORTED_MODULE_2__.Bd)(),uploadMutation=(0,_tanstack_react_query__WEBPACK_IMPORTED_MODULE_4__.n)({mutationFn:async formData=>(0,_apiClient__WEBPACK_IMPORTED_MODULE_0__.n)("/api/upload",{method:"POST",body:formData})});return async(files,gps)=>{if(!files||0===files.length)return;const id=crypto.randomUUID(),preview=URL.createObjectURL(files[0]);sessionStorage.setItem(`preview-${id}`,preview);(await Promise.all(Array.from(files).map((file,idx)=>{const formData=new FormData;formData.append("photo",file),formData.append("caseId",id),gps&&(formData.append("lat",String(gps.lat)),formData.append("lon",String(gps.lon)));const upload=uploadMutation.mutateAsync(formData);return 0===idx&&upload.then(()=>{sessionStorage.removeItem(`preview-${id}`)}),upload}))).some(r=>!r.ok)?notify(t("failedUpload")):router.push(`/cases/${id}`)}}}}]);